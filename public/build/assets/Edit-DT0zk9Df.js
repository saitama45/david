import{T as De,x as v,ax as xe,y as oe,l as Ve,V as ke,r as m,o as i,c as q,w as a,g as u,a as l,b as c,t as x,u as d,d as y,e as A,F as z,m as K,O as Ue,k,n as $e,h as P,z as ae,ay as Ie,az as re,W as Te}from"./app-Bp7xdNcv.js";import{u as qe}from"./use-toast-DT_1psKJ.js";import{C as Me,_ as Oe}from"./ConfirmationModal-CZKEx2Up.js";import{L as Ae}from"./loader-circle-B3602dnw.js";import{C as ze}from"./calendar-iIJQHMiE.js";const Fe={class:"relative"},Le={class:"relative"},Be=["value","disabled"],je={class:"absolute z-50 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg p-4 w-full min-w-[280px]"},Ee={class:"flex justify-between items-center mb-4"},Ne={class:"text-lg font-semibold"},Ye={class:"grid grid-cols-7 gap-1"},We=["onClick"],He={class:"space-y-6"},Pe={class:"grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4"},Re={key:0,class:"bg-gray-700 text-white text-xs rounded-full size-5 flex items-center justify-center mr-2"},Ge={class:"p-2 sticky top-0 bg-white z-10 border-b"},Qe=["onUpdate:modelValue"],Ke={key:0,class:"bg-gray-700 text-white text-xs rounded-full size-5 flex items-center justify-center mr-2"},Je={class:"p-2 sticky top-0 bg-white z-10 border-b"},Xe=["onUpdate:modelValue"],Ze={key:0,class:"text-center py-4"},et={key:2,class:"px-2 py-4 text-center text-gray-500"},tt={key:0,class:"bg-gray-700 text-white text-xs rounded-full size-5 flex items-center justify-center mr-2"},lt={key:0,class:"bg-gray-700 text-white text-xs rounded-full size-5 flex items-center justify-center mr-2"},st={class:"md:col-span-3 flex items-end justify-end"},ot={class:"text-sm font-semibold pt-2"},at=["onClick"],rt={class:"mt-4 flex justify-end"},nt={class:"text-lg font-bold"},ft={__name:"Edit",props:{order:{type:Object,required:!0},branches:{type:Array,required:!0},dtsSupplier:{type:Object,required:!0},variants:{type:Array,required:!0}},setup(U){const S=U,{toast:R}=qe(),o=De({supplier_id:String(S.dtsSupplier.value),order_date:S.order.order_date,variant:S.order.variant,items:S.order.store_order_items.map(t=>({id:t.id,store_branch_id:S.order.store_branch_id,initial_item_code:t.item_code,item_id:null,quantity:t.quantity_ordered,cost:t.cost_per_quantity,uom:t.uom}))}),F=v(!1),L=v(!1),$=v([]),B=v(!1),j=v([]),E=v(!1),N=v([]),I=v([]),G=v([]),Y=v([]),W=v([]),H=v(!1),C=v(new Date),ne={SUNDAY:0,MONDAY:1,TUESDAY:2,WEDNESDAY:3,THURSDAY:4,FRIDAY:5,SATURDAY:6};xe(()=>{W.value=[]});const ue=()=>(j.value||[]).map(e=>ne[e.toUpperCase()]).filter(e=>e!==void 0),de=()=>{var r;const t=ue();return t.length===0&&((r=o.items[0])!=null&&r.store_branch_id)&&o.variant?[0,1,2,3,4,5,6]:[0,1,2,3,4,5,6].filter(p=>!t.includes(p))},ie=()=>{const t=[],e=C.value||new Date,r=e.getFullYear(),p=e.getMonth(),f=new Date(r,p,1).getDay(),w=new Date(r,p+1,0).getDate(),b=de(),D=new Date;D.setHours(0,0,0,0);const V=new Date(D);V.setDate(D.getDate()+(6-D.getDay()));for(let g=0;g<f;g++)t.push(null);for(let g=1;g<=w;g++){const h=new Date(r,p,g),M=h.getDay(),O=b.includes(M)||h<=V;t.push({day:g,date:h,isDisabled:O})}return t},ce=()=>C.value=new Date(C.value.getFullYear(),C.value.getMonth()-1,1),me=()=>C.value=new Date(C.value.getFullYear(),C.value.getMonth()+1,1),pe=t=>{if(t&&!t.isDisabled){const e=t.date,r=e.getFullYear(),p=String(e.getMonth()+1).padStart(2,"0"),f=String(e.getDate()).padStart(2,"0");o.order_date=`${r}-${p}-${f}`,H.value=!1}},J=async(t,e)=>{if(!t||!e){j.value=[];return}E.value=!0;try{const r=await re.get(route("dts-orders.get-schedule"),{params:{store_branch_id:t,variant:e}});j.value=r.data}catch{R({title:"Error",description:"Could not fetch delivery schedule.",variant:"destructive"}),j.value=[]}finally{E.value=!1}},X=async t=>{if(!t||!o.supplier_id){$.value=[];return}B.value=!0;try{const e=await re.get(route("dts-orders.get-items-by-variant"),{params:{variant:t,supplier_id:o.supplier_id}});$.value=e.data}catch{R({title:"Error",description:"Failed to load items.",variant:"destructive"})}finally{B.value=!1}};oe(()=>{var t;return{branch:(t=o.items[0])==null?void 0:t.store_branch_id,variant:o.variant}},(t,e)=>{L.value||(t.branch!==e.branch||t.variant!==e.variant)&&(o.order_date=null,J(t.branch,t.variant))},{deep:!0}),oe(()=>o.variant,(t,e)=>{var r;L.value||t!==e&&(o.items=[{store_branch_id:((r=o.items[0])==null?void 0:r.store_branch_id)||null,item_id:null,quantity:0,cost:0,uom:null}],I.value=[],t?X(t):$.value=[])});const fe=t=>{const e=N.value[t]||"";return S.branches.filter(r=>r.label.toLowerCase().includes(e.toLowerCase()))},Z=t=>{const e=I.value[t]||"";return $.value.filter(r=>r.label.toLowerCase().includes(e.toLowerCase()))},_e=(t,e)=>{const r=$.value.find(p=>p.value===e);r&&(o.items[t]={...o.items[t],item_id:r.value,uom:r.uom,cost:r.cost}),I.value[t]="",Y.value[t]=!1},ve=async()=>{L.value=!0;const t=o.items[o.items.length-1],e=o.items.length-1,r=document.getElementById(`uom_${e}`),p=r?r.value:null;o.items.push({store_branch_id:(t==null?void 0:t.store_branch_id)||null,item_id:(t==null?void 0:t.item_id)||null,quantity:(t==null?void 0:t.quantity)||0,cost:(t==null?void 0:t.cost)||0,uom:null}),await Te();const f=o.items.length-1;o.items[f].uom=p;const w=W.value[f];if(w){const b=w.$el||w;b&&typeof b.focus=="function"&&(b.focus(),b.select())}L.value=!1},ye=t=>{o.items.splice(t,1),W.value.splice(t,1),[N,I,G,Y].forEach(r=>{Array.isArray(r.value)&&r.value.splice(t,1)})},ge=()=>{F.value=!0},be=()=>{o.transform(t=>({...t,items:t.items.map(e=>({...e,variant:t.variant}))})).put(route("dts-orders.update",S.order.order_number),{onSuccess:()=>{R({title:"Success!",description:"DTS Order updated successfully.",variant:"success"})},onFinish:()=>{F.value=!1}})},ee=t=>new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(t),he=t=>(o.items[t].quantity||0)*(o.items[t].cost||0),Se=Ve(()=>o.items.reduce((t,e)=>t+(e.quantity||0)*(e.cost||0),0));return ke(async()=>{C.value=new Date(S.order.order_date),o.variant&&await X(o.variant);const t=S.order.store_order_items.map(e=>{const r=$.value.find(p=>p.item_code===e.item_code);return{id:e.id,store_branch_id:S.order.store_branch_id,initial_item_code:e.item_code,item_id:r?r.value:null,quantity:e.quantity_ordered,cost:r?r.cost:e.cost_per_quantity,uom:r?r.uom:e.uom}});o.items=t,o.items.length>0&&o.items[0].store_branch_id&&o.variant&&await J(o.items[0].store_branch_id,o.variant)}),(t,e)=>{const r=m("CardTitle"),p=m("CardHeader"),f=m("Label"),w=m("SelectValue"),b=m("SelectTrigger"),D=m("SelectItem"),V=m("SelectContent"),g=m("SelectShad"),h=m("InputContainer"),M=m("SelectLabel"),O=m("SelectGroup"),T=m("FormError"),te=m("CardContent"),le=m("Card"),Q=m("Input"),se=m("Button"),we=m("CardFooter"),Ce=m("Layout");return i(),q(Ce,{heading:"Edit DTS Order"},{default:a(()=>[u("form",{onSubmit:k(ge,["prevent"]),class:"space-y-6"},[l(le,null,{default:a(()=>[l(p,null,{default:a(()=>[l(r,null,{default:a(()=>e[9]||(e[9]=[c("DTS Order Details")])),_:1})]),_:1}),l(te,{class:"grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4"},{default:a(()=>{var _;return[l(h,null,{default:a(()=>[l(f,null,{default:a(()=>e[10]||(e[10]=[c("Supplier")])),_:1}),l(g,{"model-value":String(U.dtsSupplier.value),disabled:""},{default:a(()=>[l(b,null,{default:a(()=>[l(w,{placeholder:U.dtsSupplier.label},null,8,["placeholder"])]),_:1}),l(V,null,{default:a(()=>[l(D,{value:String(U.dtsSupplier.value)},{default:a(()=>[c(x(U.dtsSupplier.label),1)]),_:1},8,["value"])]),_:1})]),_:1},8,["model-value"])]),_:1}),l(h,null,{default:a(()=>{var s;return[l(f,{for:"variant",class:"flex items-center"},{default:a(()=>e[11]||(e[11]=[u("span",{class:"bg-gray-700 text-white text-xs rounded-full size-5 flex items-center justify-center mr-2"},"2",-1),c("Variant")])),_:1}),l(g,{modelValue:d(o).variant,"onUpdate:modelValue":e[0]||(e[0]=n=>d(o).variant=n),disabled:!((s=d(o).items[0])!=null&&s.store_branch_id)},{default:a(()=>[l(b,{id:"variant"},{default:a(()=>[l(w,{placeholder:"Select Variant..."})]),_:1}),l(V,null,{default:a(()=>[l(O,null,{default:a(()=>[l(M,null,{default:a(()=>e[12]||(e[12]=[c("Variants")])),_:1}),(i(!0),y(z,null,A(U.variants,n=>(i(),q(D,{key:n,value:n},{default:a(()=>[c(x(n),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue","disabled"]),l(T,{message:d(o).errors.variant},null,8,["message"])]}),_:1}),u("div",Fe,[l(f,{for:"order_date",class:"flex items-center"},{default:a(()=>e[13]||(e[13]=[u("span",{class:"bg-gray-700 text-white text-xs rounded-full size-5 flex items-center justify-center mr-2"},"3",-1),c("Order Date")])),_:1}),u("div",Le,[u("input",{id:"order_date",type:"text",readonly:"",value:d(o).order_date,onClick:e[1]||(e[1]=s=>H.value=!H.value),disabled:!((_=d(o).items[0])!=null&&_.store_branch_id)||!d(o).variant||E.value,class:"flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 cursor-pointer",placeholder:"Select date"},null,8,Be),E.value?(i(),q(d(Ae),{key:0,class:"absolute right-3 top-1/2 -translate-y-1/2 size-4 text-gray-500 animate-spin"})):(i(),q(d(ze),{key:1,class:"absolute right-3 top-1/2 -translate-y-1/2 size-4 text-gray-500 pointer-events-none"}))]),l(T,{message:d(o).errors.order_date},null,8,["message"]),K(u("div",je,[u("div",Ee,[u("button",{type:"button",onClick:e[2]||(e[2]=k(s=>ce(),["stop"])),class:"p-2 rounded-full hover:bg-gray-200"},"<"),u("h2",Ne,x((C.value||new Date).toLocaleString("default",{month:"long",year:"numeric"})),1),u("button",{type:"button",onClick:e[3]||(e[3]=k(s=>me(),["stop"])),class:"p-2 rounded-full hover:bg-gray-200"},">")]),e[14]||(e[14]=u("div",{class:"grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-500 mb-2"},[u("span",null,"Su"),u("span",null,"Mo"),u("span",null,"Tu"),u("span",null,"We"),u("span",null,"Th"),u("span",null,"Fr"),u("span",null,"Sa")],-1)),u("div",Ye,[(i(!0),y(z,null,A(ie(),(s,n)=>(i(),y("div",{key:n,class:$e(["text-center py-1.5 rounded-full text-sm",{"bg-gray-200 text-gray-400 cursor-not-allowed":s&&s.isDisabled,"bg-blue-500 text-white":s&&!s.isDisabled&&d(o).order_date&&s.date.toDateString()===new Date(d(o).order_date+"T00:00:00").toDateString(),"hover:bg-gray-200 cursor-pointer":s&&!s.isDisabled}]),onClick:ut=>pe(s)},x(s?s.day:""),11,We))),128))])],512),[[Ue,H.value]])])]}),_:1})]),_:1}),l(le,null,{default:a(()=>[l(p,null,{default:a(()=>[l(r,null,{default:a(()=>e[15]||(e[15]=[c("Order Items")])),_:1})]),_:1}),l(te,null,{default:a(()=>[u("div",He,[(i(!0),y(z,null,A(d(o).items,(_,s)=>(i(),y("div",{key:s,class:"p-4 border rounded-lg shadow-sm bg-gray-50 relative"},[u("div",Pe,[l(h,null,{default:a(()=>[l(f,{for:`branch_${s}`,class:"flex items-center"},{default:a(()=>[s===0?(i(),y("span",Re,"1")):P("",!0),e[16]||(e[16]=c("Store Branch"))]),_:2},1032,["for"]),l(g,{modelValue:_.store_branch_id,"onUpdate:modelValue":n=>_.store_branch_id=n,open:G.value[s],"onUpdate:open":n=>G.value[s]=n},{default:a(()=>[l(b,{id:`branch_${s}`},{default:a(()=>[l(w,{placeholder:"Select Branch..."})]),_:2},1032,["id"]),l(V,null,{default:a(()=>[u("div",Ge,[K(u("input",{type:"text","onUpdate:modelValue":n=>N.value[s]=n,placeholder:"Search...",class:"w-full px-3 py-1.5 border rounded-md",onClick:e[4]||(e[4]=k(()=>{},["stop"])),onKeydown:e[5]||(e[5]=k(()=>{},["stop"]))},null,40,Qe),[[ae,N.value[s]]])]),l(O,null,{default:a(()=>[l(M,null,{default:a(()=>e[17]||(e[17]=[c("Branches")])),_:1}),(i(!0),y(z,null,A(fe(s),n=>(i(),q(D,{key:n.value,value:String(n.value)},{default:a(()=>[c(x(n.label),1)]),_:2},1032,["value"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1032,["modelValue","onUpdate:modelValue","open","onUpdate:open"]),l(T,{message:d(o).errors[`items.${s}.store_branch_id`]},null,8,["message"])]),_:2},1024),l(h,null,{default:a(()=>[l(f,{for:`item_${s}`,class:"flex items-center"},{default:a(()=>[s===0?(i(),y("span",Ke,"4")):P("",!0),e[18]||(e[18]=c("Item"))]),_:2},1032,["for"]),l(g,{modelValue:_.item_id,"onUpdate:modelValue":[n=>_.item_id=n,n=>_e(s,n)],open:Y.value[s],"onUpdate:open":n=>Y.value[s]=n,disabled:B.value||!d(o).variant},{default:a(()=>[l(b,{id:`item_${s}`},{default:a(()=>[l(w,{placeholder:"Select Item..."})]),_:2},1032,["id"]),l(V,null,{default:a(()=>[u("div",Je,[K(u("input",{type:"text","onUpdate:modelValue":n=>I.value[s]=n,placeholder:"Search...",class:"w-full px-3 py-1.5 border rounded-md",onClick:e[6]||(e[6]=k(()=>{},["stop"])),onKeydown:e[7]||(e[7]=k(()=>{},["stop"]))},null,40,Xe),[[ae,I.value[s]]])]),l(O,null,{default:a(()=>[l(M,null,{default:a(()=>e[19]||(e[19]=[c("Items")])),_:1}),B.value?(i(),y("div",Ze,"Loading...")):Z(s).length>0?(i(!0),y(z,{key:1},A(Z(s),n=>(i(),q(D,{key:n.value,value:String(n.value)},{default:a(()=>[c(x(n.label),1)]),_:2},1032,["value"]))),128)):(i(),y("div",et,"No items found"))]),_:2},1024)]),_:2},1024)]),_:2},1032,["modelValue","onUpdate:modelValue","open","onUpdate:open","disabled"]),l(T,{message:d(o).errors[`items.${s}.item_id`]},null,8,["message"])]),_:2},1024),l(h,null,{default:a(()=>[l(f,{for:`quantity_${s}`,class:"flex items-center"},{default:a(()=>[s===0?(i(),y("span",tt,"5")):P("",!0),e[20]||(e[20]=c("Quantity"))]),_:2},1032,["for"]),l(Q,{ref_for:!0,ref:n=>{n&&(W.value[s]=n)},id:`quantity_${s}`,modelValue:_.quantity,"onUpdate:modelValue":n=>_.quantity=n,modelModifiers:{number:!0},type:"number",step:"0.01",min:"0"},null,8,["id","modelValue","onUpdate:modelValue"]),l(T,{message:d(o).errors[`items.${s}.quantity`]},null,8,["message"])]),_:2},1024),l(h,null,{default:a(()=>[l(f,{for:`uom_${s}`},{default:a(()=>e[21]||(e[21]=[c("UOM")])),_:2},1032,["for"]),l(Q,{id:`uom_${s}`,modelValue:_.uom,"onUpdate:modelValue":n=>_.uom=n,disabled:"",placeholder:"UOM"},null,8,["id","modelValue","onUpdate:modelValue"])]),_:2},1024),l(h,null,{default:a(()=>[l(f,{for:`cost_${s}`,class:"flex items-center"},{default:a(()=>[s===0?(i(),y("span",lt,"6")):P("",!0),e[22]||(e[22]=c("Cost"))]),_:2},1032,["for"]),l(Q,{id:`cost_${s}`,modelValue:_.cost,"onUpdate:modelValue":n=>_.cost=n,modelModifiers:{number:!0},type:"number",step:"0.01",min:"0"},null,8,["id","modelValue","onUpdate:modelValue"]),l(T,{message:d(o).errors[`items.${s}.cost`]},null,8,["message"])]),_:2},1024),u("div",st,[u("div",ot,"Item Total: "+x(ee(he(s))),1)])]),u("button",{type:"button",onClick:n=>ye(s),class:"absolute top-2 right-2 text-red-500 hover:text-red-700 transition-colors"},[l(d(Ie),{class:"size-5"})],8,at)]))),128))]),u("div",rt,[l(se,{type:"button",onClick:ve,variant:"ghost",class:"text-blue-500 hover:bg-blue-100"},{default:a(()=>[l(d(Me),{class:"size-4 mr-2"}),e[23]||(e[23]=c(" Add one more item"))]),_:1})])]),_:1}),l(we,{class:"flex justify-between items-center mt-6 p-6 border-t"},{default:a(()=>[u("div",nt,"Overall Total: "+x(ee(Se.value)),1),l(se,{type:"submit",disabled:d(o).processing},{default:a(()=>e[24]||(e[24]=[c("Update Order")])),_:1},8,["disabled"])]),_:1})]),_:1})],32),l(Oe,{show:F.value,title:"Update Order",message:"Are you sure you want to update this order? This action cannot be undone.",onConfirm:be,onCancel:e[8]||(e[8]=_=>F.value=!1)},null,8,["show"])]),_:1})}}};export{ft as default};
