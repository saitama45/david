import{f as Fe,x as v,bv as qe,T as ee,V as Ie,y as q,l as Q,bq as Ne,az as A,r as m,o as I,c as he,w as l,g as u,a as t,b as o,u as p,s as J,t as f,m as Be,O as Te,n as te,k as le,d as B,e as re,F as oe,ay as ae,N as ke}from"./app-Bp7xdNcv.js";import{u as Ve}from"./useSelectOptions-DNoqVwQ-.js";import{u as Ee}from"./useToast-BYf4YE8m.js";import{u as Le}from"./useBackButton-B5cTAtmc.js";import{C as Me}from"./calendar-iIJQHMiE.js";const Ue={class:"grid sm:grid-cols-3 gap-5 grid-cols-1"},je={class:"grid gap-5"},$e={class:"flex flex-col space-y-1"},Qe={class:"flex flex-col space-y-1"},Ae={class:"relative"},Pe=["value","disabled"],He={class:"flex justify-between items-center mb-4"},Re={class:"text-lg font-semibold"},ze={class:"grid grid-cols-7 gap-2"},Ye=["onClick"],Je={class:"flex flex-col space-y-1"},We={class:"flex flex-col space-y-1"},Xe={key:0,class:"p-4 text-center text-gray-500"},Ge={key:1,class:"p-4 text-center text-gray-500"},Ke={class:"flex flex-col space-y-1"},Ze={class:"flex flex-col space-y-1"},et={class:"flex flex-col space-y-1"},tt={class:"overflow-x-auto"},lt=["onClick"],ut={__name:"Edit",props:{order:{type:Object,required:!0},orderedItems:{type:Object,required:!0},branches:{type:Object,required:!0},suppliers:{type:Object,required:!0},enabledDates:{type:Array,required:!0}},setup(se){const _=se,E=Fe(),{toast:x}=Ee();Le(route("store-orders.index"));const N=v(null),W=v(null);qe(()=>{const a=localStorage.getItem("editStoreOrderDraft"),e=localStorage.getItem("previoustoreOrderNumber");a&&(N.value=JSON.parse(a)),e&&(W.value=e)});const L=v(!1),r=ee({supplier_id:_.order.supplier.supplier_code+"",order_date:_.order.order_date,branch_id:_.order.store_branch_id?String(_.order.store_branch_id):null,orders:[]}),M=async a=>{if(!a){j.value=[];return}F.value=!0;try{const e=await A.get(route("store-orders.get-supplier-items",a));j.value=e.data.items}catch{x.add({severity:"error",summary:"Error",detail:"Failed to load items.",life:5e3}),j.value=[]}finally{F.value=!1}};Ie(()=>{N.value&&W.value===_.order.order_number?E.require({message:"You have an unfinished draft. Would you like to continue where you left off or discard it?",header:"Unfinished Draft Detected",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Discard",severity:"danger"},acceptProps:{label:"Continue",severity:"primary"},accept:()=>{r.supplier_id=N.value.supplier_id,r.order_date=N.value.order_date,r.branch_id=N.value.branch_id,r.orders=N.value.orders||[],r.supplier_id&&(M(r.supplier_id),q(()=>r.supplier_id,()=>{},{immediate:!0}),r.order_date&&q(()=>r.order_date,()=>{},{immediate:!0}))},reject:()=>{X(),M(_.order.supplier.supplier_code)}}):(X(),M(_.order.supplier.supplier_code)),L.value=!0});const X=()=>{const a=_.orderedItems.map(e=>{let s=1,c=null;if(e.supplier_item&&e.supplier_item.sap_master_file){const S=e.supplier_item.sap_master_file;s=Number(S.BaseQty)||1,c=S.BaseUOM}const d=Number(e.quantity_ordered),b=Number(e.cost_per_quantity),g=parseFloat((d*s).toFixed(2)),y=parseFloat((g*b).toFixed(2));return{id:e.id,inventory_code:String(e.supplier_item.ItemCode),name:e.supplier_item.item_name,unit_of_measurement:e.supplier_item.uom,base_uom:c,base_qty:s,base_uom_qty:g,quantity:d,cost:b,total_cost:y,uom:e.supplier_item.uom}});r.orders=a},U=v(_.branches),{options:ne}=Ve(_.suppliers),ie=Q(()=>Object.entries(U.value||{}).map(([a,e])=>({value:a,label:e}))),j=v([]),T=v(null),F=v(!1),$=v(!1),P=v(_.enabledDates),k=v(!1),w=v(new Date(_.order.order_date+"T00:00:00")),H=v(null),R=v("top-full mt-2");q(k,a=>{if(a&&H.value){const e=H.value.getBoundingClientRect(),s=400;window.innerHeight-e.bottom<s&&e.top>s?R.value="bottom-full mb-2":R.value="top-full mt-2"}});const ue=()=>{const a=[],e=w.value,s=e.getFullYear(),c=e.getMonth(),d=new Date(s,c,1).getDay(),b=new Date(s,c+1,0).getDate(),g=new Set(P.value);for(let y=0;y<d;y++)a.push(null);for(let y=1;y<=b;y++){const S=new Date(s,c,y),h=`${S.getFullYear()}-${String(S.getMonth()+1).padStart(2,"0")}-${String(S.getDate()).padStart(2,"0")}`,V=!g.has(h);a.push({day:y,date:S,isDisabled:V})}return a},de=()=>w.value=new Date(w.value.getFullYear(),w.value.getMonth()-1,1),pe=()=>w.value=new Date(w.value.getFullYear(),w.value.getMonth()+1,1),me=a=>{if(a&&!a.isDisabled){const e=a.date;r.order_date=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,k.value=!1}};q(r,a=>{L.value&&(localStorage.setItem("editStoreOrderDraft",JSON.stringify(a)),localStorage.setItem("previoustoreOrderNumber",_.order.order_number))},{deep:!0});const O=ee({item:null}),i=Ne({id:null,inventory_code:null,name:null,unit_of_measurement:null,base_uom:null,base_qty:null,quantity:null,cost:null,total_cost:null,uom:null}),ce=a=>{E.require({message:"Are you sure you want to remove this item?",header:"Confirmation",icon:"pi pi-exclamation-triangle",accept:()=>{r.orders=r.orders.filter(e=>e.id!==a),x.add({severity:"success",summary:"Confirmed",detail:"Item Removed",life:3e3})}})},fe=()=>{E.require({message:"Are you sure you want to remove ALL items?",header:"Confirmation",icon:"pi pi-exclamation-triangle",accept:()=>{r.orders=[],x.add({severity:"success",summary:"Confirmed",detail:"All items removed.",life:3e3})}})},_e=()=>{if(O.clearErrors(),!O.item)return O.setError("item","Item field is required");if(isNaN(Number(i.quantity))||Number(i.quantity)<.1)return O.setError("quantity","Quantity must be at least 0.1");if(i.cost===null||Number(i.cost)===0)return x.add({severity:"error",summary:"Validation Error",detail:"Item cost cannot be zero.",life:5e3});const a=r.orders.findIndex(d=>d.inventory_code===i.inventory_code),e=Number(i.base_qty)>0?Number(i.base_qty):1,s=Number(i.quantity),c=Number(i.cost);if(a!==-1){const d=r.orders[a],b=d.quantity+s,g=Number(d.base_qty)>0?Number(d.base_qty):1;d.quantity=b,d.base_uom_qty=parseFloat((b*g).toFixed(2)),d.total_cost=parseFloat((d.base_uom_qty*c).toFixed(2))}else{const d=parseFloat((s*e).toFixed(2)),b=parseFloat((d*c).toFixed(2));r.orders.push({...i,id:null,quantity:s,base_uom_qty:d,total_cost:b})}Object.keys(i).forEach(d=>i[d]=null),T.value=null,x.add({severity:"success",summary:"Success",detail:"Item added successfully.",life:5e3}),O.item=null},be=()=>{if(r.orders.length<1)return x.add({severity:"error",summary:"Error",detail:"Please select at least one item.",life:5e3});if(!r.order_date)return r.setError("order_date","Order date is required.");const a=e=>{if(!e||typeof e=="string")return e;const s=new Date(e);return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`};r.order_date=a(r.order_date),E.require({message:"Are you sure you want to update the order details?",header:"Confirmation",icon:"pi pi-exclamation-triangle",accept:()=>{r.put(route("store-orders.update",_.order.id),{onSuccess:()=>{localStorage.removeItem("editStoreOrderDraft"),localStorage.removeItem("previoustoreOrderNumber"),ke.visit(route("store-orders.index"))},onError:e=>x.add({severity:"error",summary:"Error",detail:e.error||e.message||"Can't update the order.",life:5e3})})}})};q(T,async a=>{if(a){F.value=!0,O.item=a;try{const s=(await A.get(route("SupplierItems.get-details-by-code",{itemCode:a,supplierCode:r.supplier_id}))).data.item;if(s){i.inventory_code=String(s.ItemCode),i.name=s.item_name,i.unit_of_measurement=s.uom,i.cost=Number(s.cost),i.uom=s.uom;let c=null,d=1;s.sap_master_file&&(c=s.sap_master_file.BaseUOM,d=Number(s.sap_master_file.BaseQty)||1),i.base_uom=c,i.base_qty=d}else x.add({severity:"error",summary:"Error",detail:"Item details not found.",life:5e3})}catch{x.add({severity:"error",summary:"Error",detail:"Failed to load item details.",life:5e3})}finally{F.value=!1}}else Object.keys(i).forEach(e=>i[e]=null)},{deep:!0}),q(()=>r.supplier_id,async a=>{if(L.value){if(r.order_date=null,r.branch_id=null,U.value={},T.value=null,Object.keys(i).forEach(e=>i[e]=null),M(a),P.value=[],!a){$.value=!0;return}$.value=!0;try{const e=await A.get(route("store-orders.available-dates",{supplier_code:a}));P.value=e.data,$.value=!1}catch{x.add({severity:"error",summary:"Error",detail:"Failed to load available dates.",life:5e3})}}}),q(()=>r.order_date,async a=>{if(L.value)if(r.branch_id=null,a&&r.supplier_id)try{const e=await A.get(route("store-orders.get-branches",{order_date:a,supplier_code:r.supplier_id}));U.value=e.data}catch(e){console.error("Error fetching branches:",e),x.add({severity:"error",summary:"Error",detail:"Failed to load store branches.",life:5e3})}else U.value={}});const ye=Q(()=>!!r.supplier_id),z=Q(()=>r.orders.length>0),ve=Q(()=>r.orders.reduce((a,e)=>a+parseFloat(e.total_cost),0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),ge=`Edit Order #${_.order.order_number}`;return(a,e)=>{const s=m("CardTitle"),c=m("CardDescription"),d=m("CardHeader"),b=m("InputLabel"),g=m("FormError"),y=m("CardContent"),S=m("Card"),h=m("Label"),V=m("Input"),Y=m("Button"),G=m("CardFooter"),xe=m("LabelXS"),Se=m("SpanBold"),K=m("DivFlexCenter"),D=m("TH"),De=m("TableHead"),C=m("TD"),Ce=m("TableBody"),we=m("Table"),Oe=m("Layout");return I(),he(Oe,{heading:ge},{default:l(()=>[u("div",Ue,[u("section",je,[t(S,null,{default:l(()=>[t(d,null,{default:l(()=>[t(s,null,{default:l(()=>e[9]||(e[9]=[o("Order Details")])),_:1}),t(c,null,{default:l(()=>e[10]||(e[10]=[o("Please input all the fields")])),_:1})]),_:1}),t(y,{class:"space-y-3"},{default:l(()=>[u("div",$e,[t(b,{label:"Supplier"}),t(p(J),{filter:"",placeholder:"Select a Supplier",modelValue:p(r).supplier_id,"onUpdate:modelValue":e[0]||(e[0]=n=>p(r).supplier_id=n),options:p(ne),optionLabel:"label",optionValue:"value",disabled:z.value},null,8,["modelValue","options","disabled"]),t(g,null,{default:l(()=>[o(f(p(r).errors.supplier_id),1)]),_:1})]),u("div",Qe,[t(b,{label:"Order Date"}),u("div",{class:"relative",ref_key:"dateInputRef",ref:H},[u("div",Ae,[u("input",{id:"order_date",type:"text",readonly:"",value:p(r).order_date,onClick:e[1]||(e[1]=n=>k.value=!k.value),disabled:$.value||z.value,class:"flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-gray-400 disabled:cursor-not-allowed disabled:opacity-50 cursor-pointer",placeholder:"Select a date"},null,8,Pe),t(p(Me),{class:"absolute right-3 top-1/2 -translate-y-1/2 size-4 text-gray-500 pointer-events-none"})]),Be(u("div",{class:te(["absolute z-50 bg-white border border-gray-200 rounded-lg shadow-lg p-4 w-full min-w-[300px]",R.value])},[u("div",He,[u("button",{type:"button",onClick:e[2]||(e[2]=le(n=>de(),["stop"])),class:"p-2 rounded-full hover:bg-gray-100"},"<"),u("h2",Re,f(w.value.toLocaleString("default",{month:"long",year:"numeric"})),1),u("button",{type:"button",onClick:e[3]||(e[3]=le(n=>pe(),["stop"])),class:"p-2 rounded-full hover:bg-gray-100"},">")]),e[11]||(e[11]=u("div",{class:"grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-500 mb-2"},[u("span",null,"Su"),u("span",null,"Mo"),u("span",null,"Tu"),u("span",null,"We"),u("span",null,"Th"),u("span",null,"Fr"),u("span",null,"Sa")],-1)),u("div",ze,[(I(!0),B(oe,null,re(ue(),(n,Z)=>(I(),B("div",{key:Z,class:te(["text-center py-1.5 rounded-full text-sm",[n?n.isDisabled?"text-gray-300 line-through cursor-not-allowed":p(r).order_date&&n.date.toDateString()===new Date(p(r).order_date+"T00:00:00").toDateString()?"bg-blue-600 text-white font-bold shadow-md":"bg-gray-100 text-gray-800 font-semibold cursor-pointer hover:bg-blue-100":""]]),onClick:rt=>me(n)},f(n?n.day:""),11,Ye))),128))])],2),[[Te,k.value]])],512),t(g,null,{default:l(()=>[o(f(p(r).errors.order_date),1)]),_:1})]),u("div",Je,[t(b,{label:"Store Branch"}),t(p(J),{filter:"",placeholder:"Select a Store",modelValue:p(r).branch_id,"onUpdate:modelValue":e[4]||(e[4]=n=>p(r).branch_id=n),options:ie.value,optionLabel:"label",optionValue:"value",disabled:z.value},null,8,["modelValue","options","disabled"]),t(g,null,{default:l(()=>[o(f(p(r).errors.branch_id),1)]),_:1})])]),_:1})]),_:1}),t(S,null,{default:l(()=>[t(d,null,{default:l(()=>[t(s,null,{default:l(()=>e[12]||(e[12]=[o("Add Item")])),_:1}),t(c,null,{default:l(()=>e[13]||(e[13]=[o("Please input all the fields")])),_:1})]),_:1}),t(y,{class:"space-y-3"},{default:l(()=>[u("div",We,[t(h,null,{default:l(()=>e[14]||(e[14]=[o("Item")])),_:1}),t(p(J),{filter:"",placeholder:"Select an Item",modelValue:T.value,"onUpdate:modelValue":e[5]||(e[5]=n=>T.value=n),options:j.value,optionLabel:"label",optionValue:"value",disabled:!ye.value||F.value},{empty:l(()=>[F.value?(I(),B("div",Xe,"Loading items...")):(I(),B("div",Ge,"No items available for this supplier."))]),_:1},8,["modelValue","options","disabled"]),t(g,null,{default:l(()=>[o(f(p(O).errors.item),1)]),_:1})]),u("div",Ke,[t(h,null,{default:l(()=>e[15]||(e[15]=[o("Unit Of Measurement (UOM)")])),_:1}),t(V,{type:"text",disabled:"",modelValue:i.unit_of_measurement,"onUpdate:modelValue":e[6]||(e[6]=n=>i.unit_of_measurement=n)},null,8,["modelValue"])]),u("div",Ze,[t(h,null,{default:l(()=>e[16]||(e[16]=[o("Cost")])),_:1}),t(V,{type:"text",disabled:"",modelValue:i.cost,"onUpdate:modelValue":e[7]||(e[7]=n=>i.cost=n)},null,8,["modelValue"])]),u("div",et,[t(h,null,{default:l(()=>e[17]||(e[17]=[o("Quantity")])),_:1}),t(V,{type:"number",modelValue:i.quantity,"onUpdate:modelValue":e[8]||(e[8]=n=>i.quantity=n)},null,8,["modelValue"]),t(g,null,{default:l(()=>[o(f(p(O).errors.quantity),1)]),_:1})])]),_:1}),t(G,{class:"flex justify-end"},{default:l(()=>[t(Y,{onClick:_e,disabled:F.value},{default:l(()=>e[18]||(e[18]=[o("Add to Orders")])),_:1},8,["disabled"])]),_:1})]),_:1})]),t(S,{class:"col-span-2 flex flex-col"},{default:l(()=>[t(d,{class:"flex justify-between"},{default:l(()=>[t(K,{class:"justify-between"},{default:l(()=>[t(s,null,{default:l(()=>e[19]||(e[19]=[o("Items List")])),_:1}),t(K,{class:"gap-2"},{default:l(()=>[t(xe,null,{default:l(()=>e[20]||(e[20]=[o(" Overall Total:")])),_:1}),t(Se,null,{default:l(()=>[o(f(ve.value),1)]),_:1}),t(Y,{onClick:fe,variant:"outline",class:"text-red-500",disabled:p(r).orders.length===0},{default:l(()=>[t(p(ae),{class:"size-4 mr-1"}),e[21]||(e[21]=o(" Delete All "))]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}),t(y,{class:"flex-1"},{default:l(()=>[u("div",tt,[t(we,null,{default:l(()=>[t(De,null,{default:l(()=>[t(D,null,{default:l(()=>e[22]||(e[22]=[o("Name")])),_:1}),e[31]||(e[31]=o()),t(D,null,{default:l(()=>e[23]||(e[23]=[o("Code")])),_:1}),e[32]||(e[32]=o()),t(D,null,{default:l(()=>e[24]||(e[24]=[o("Ordered Qty")])),_:1}),e[33]||(e[33]=o()),t(D,null,{default:l(()=>e[25]||(e[25]=[o("Unit")])),_:1}),e[34]||(e[34]=o()),t(D,null,{default:l(()=>e[26]||(e[26]=[o("BaseUOM Qty")])),_:1}),e[35]||(e[35]=o()),t(D,null,{default:l(()=>e[27]||(e[27]=[o("Base UOM")])),_:1}),e[36]||(e[36]=o()),t(D,null,{default:l(()=>e[28]||(e[28]=[o("Cost")])),_:1}),e[37]||(e[37]=o()),t(D,null,{default:l(()=>e[29]||(e[29]=[o("Total Cost")])),_:1}),e[38]||(e[38]=o()),t(D,null,{default:l(()=>e[30]||(e[30]=[o("Action")])),_:1})]),_:1}),t(Ce,null,{default:l(()=>[(I(!0),B(oe,null,re(p(r).orders,n=>(I(),B("tr",{key:n.id},[t(C,null,{default:l(()=>[o(f(n.name),1)]),_:2},1024),t(C,null,{default:l(()=>[o(f(n.inventory_code),1)]),_:2},1024),t(C,null,{default:l(()=>[o(f(n.quantity),1)]),_:2},1024),t(C,null,{default:l(()=>[o(f(n.unit_of_measurement),1)]),_:2},1024),t(C,null,{default:l(()=>[o(f(n.base_uom_qty),1)]),_:2},1024),t(C,null,{default:l(()=>[o(f(n.base_uom),1)]),_:2},1024),t(C,null,{default:l(()=>[o(f(Number(n.cost).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1)]),_:2},1024),t(C,null,{default:l(()=>[o(f(Number(n.total_cost).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1)]),_:2},1024),t(C,{class:"flex gap-3"},{default:l(()=>[u("button",{onClick:Z=>ce(n.id),variant:"outline",class:"text-red-500 size-5"},[t(p(ae))],8,lt)]),_:2},1024)]))),128))]),_:1})]),_:1})])]),_:1}),t(G,{class:"flex justify-end"},{default:l(()=>[t(Y,{onClick:be},{default:l(()=>e[39]||(e[39]=[o("Update Order")])),_:1})]),_:1})]),_:1})])]),_:1})}}};export{ut as default};
