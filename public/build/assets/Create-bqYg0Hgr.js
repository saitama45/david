import{f as Se,x as v,bv as we,T as G,V as Fe,y as q,l as j,bq as Oe,az as A,r as p,o as I,c as qe,w as l,g as i,a as t,b as o,u as m,s as z,t as c,m as Ie,O as he,n as K,k as Z,d as T,e as ee,F as te,ay as le,N as Te}from"./app-DPA7xop8.js";import{u as Ve}from"./useSelectOptions-DqOryH05.js";import{u as ke}from"./useToast-CL68v_82.js";import{C as Be}from"./calendar-CbGbSceW.js";const Ne={class:"grid sm:grid-cols-3 gap-5 grid-cols-1"},Ee={class:"grid gap-5"},Le={class:"flex flex-col space-y-1"},Me={class:"flex flex-col space-y-1"},Ue={class:"relative"},je=["value","disabled"],Ae={class:"flex justify-between items-center mb-4"},$e={class:"text-lg font-semibold"},Qe={class:"grid grid-cols-7 gap-2"},Pe=["onClick"],He={class:"flex flex-col space-y-1"},Re={class:"flex flex-col space-y-1"},ze={key:0,class:"p-4 text-center text-gray-500"},Ye={key:1,class:"p-4 text-center text-gray-500"},Je={class:"flex flex-col space-y-1"},We={class:"flex flex-col space-y-1"},Xe={class:"flex flex-col space-y-1"},Ge={class:"overflow-x-auto"},Ke=["onClick"],ot={__name:"Create",props:{suppliers:{type:Object,required:!0}},setup(ae){const oe=ae,N=Se(),{toast:_}=ke(),D=v(null);we(()=>{const s=localStorage.getItem("storeOrderCreateDraft");s&&(D.value=JSON.parse(s))});const E=v(!1),a=G({supplier_id:null,order_date:null,branch_id:null,orders:[]}),Y=async s=>{if(!s){M.value=[];return}O.value=!0;try{const e=await A.get(route("store-orders.get-supplier-items",s));M.value=e.data.items}catch{_.add({severity:"error",summary:"Error",detail:"Failed to load items for the selected supplier.",life:5e3}),M.value=[]}finally{O.value=!1}};Fe(()=>{D.value&&N.require({message:"You have an unfinished draft. Would you like to continue where you left off or discard the draft?",header:"Unfinished Draft Detected",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Discard",severity:"danger"},acceptProps:{label:"Continue",severity:"primary"},accept:()=>{a.supplier_id=D.value.supplier_id,a.order_date=D.value.order_date,a.branch_id=D.value.branch_id,a.orders=D.value.orders||[],a.supplier_id&&(Y(a.supplier_id),new Event("change"),q(()=>a.supplier_id,()=>{},{immediate:!0}),a.order_date&&q(()=>a.order_date,()=>{},{immediate:!0}))},reject:()=>{localStorage.removeItem("storeOrderCreateDraft")}}),E.value=!0});const L=v({}),{options:se}=Ve(oe.suppliers),re=j(()=>Object.entries(L.value||{}).map(([s,e])=>({value:s,label:e}))),M=v([]),V=v(null),O=v(!1);v([]);const U=v(!0),$=v([]),k=v(!1),S=v(new Date),Q=v(null),P=v("top-full mt-2");q(k,s=>{if(s&&Q.value){const e=Q.value.getBoundingClientRect(),u=400;window.innerHeight-e.bottom<u&&e.top>u?P.value="bottom-full mb-2":P.value="top-full mt-2"}});const ne=()=>{const s=[],e=S.value,u=e.getFullYear(),f=e.getMonth(),d=new Date(u,f,1).getDay(),b=new Date(u,f+1,0).getDate(),g=new Set($.value);for(let y=0;y<d;y++)s.push(null);for(let y=1;y<=b;y++){const F=new Date(u,f,y),h=`${F.getFullYear()}-${String(F.getMonth()+1).padStart(2,"0")}-${String(F.getDate()).padStart(2,"0")}`,B=!g.has(h);s.push({day:y,date:F,isDisabled:B})}return s},ie=()=>S.value=new Date(S.value.getFullYear(),S.value.getMonth()-1,1),ue=()=>S.value=new Date(S.value.getFullYear(),S.value.getMonth()+1,1),de=s=>{if(s&&!s.isDisabled){const e=s.date;a.order_date=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,k.value=!1}};q(a,s=>{E.value&&localStorage.setItem("storeOrderCreateDraft",JSON.stringify(s))},{deep:!0});const w=G({item:null}),n=Oe({id:null,inventory_code:null,name:null,unit_of_measurement:null,base_uom:null,base_qty:null,quantity:null,cost:null,total_cost:null}),me=s=>{N.require({message:"Are you sure you want to remove this item?",header:"Confirmation",icon:"pi pi-exclamation-triangle",accept:()=>{a.orders=a.orders.filter(e=>e.id!==s),_.add({severity:"success",summary:"Confirmed",detail:"Item Removed",life:3e3})}})},pe=()=>{N.require({message:"Are you sure you want to remove ALL items?",header:"Confirmation",icon:"pi pi-exclamation-triangle",accept:()=>{a.orders=[],_.add({severity:"success",summary:"Confirmed",detail:"All items removed.",life:3e3})}})},ce=()=>{if(w.clearErrors(),!w.item)return w.setError("item","Item field is required");if(isNaN(Number(n.quantity))||Number(n.quantity)<.1)return w.setError("quantity","Quantity must be at least 0.1");if(n.cost===null||Number(n.cost)===0)return _.add({severity:"error",summary:"Validation Error",detail:"Item cost cannot be zero.",life:5e3});const s=a.orders.findIndex(d=>d.inventory_code===n.inventory_code),e=Number(n.base_qty)>0?Number(n.base_qty):1,u=Number(n.quantity),f=Number(n.cost);if(s!==-1){const d=a.orders[s],b=d.quantity+u,g=Number(d.base_qty)>0?Number(d.base_qty):1;d.quantity=b,d.base_uom_qty=parseFloat((b*g).toFixed(2)),d.total_cost=parseFloat((d.base_uom_qty*f).toFixed(2))}else{const d=parseFloat((u*e).toFixed(2)),b=parseFloat((d*f).toFixed(2));a.orders.push({...n,quantity:u,base_uom_qty:d,total_cost:b})}Object.keys(n).forEach(d=>n[d]=null),V.value=null,_.add({severity:"success",summary:"Success",detail:"Item added successfully.",life:5e3}),w.item=null},fe=()=>{if(a.orders.length<1)return _.add({severity:"error",summary:"Error",detail:"Please select at least one item.",life:5e3});if(!a.order_date)return a.setError("order_date","Order date is required.");N.require({message:"Are you sure you want to place this order?",header:"Confirmation",icon:"pi pi-exclamation-triangle",accept:()=>{a.post(route("store-orders.store"),{onSuccess:()=>{localStorage.removeItem("storeOrderCreateDraft"),Te.visit(route("store-orders.index"))},onError:s=>_.add({severity:"error",summary:"Error",detail:s.error||s.message||"Can't place the order.",life:5e3})})}})};q(V,async s=>{if(s){O.value=!0,w.item=s;try{const u=(await A.get(route("SupplierItems.get-details-by-code",{itemCode:s,supplierCode:a.supplier_id}))).data.item;if(u){n.id=u.ItemCode,n.name=u.item_name,n.inventory_code=u.ItemCode,n.unit_of_measurement=u.uom,n.cost=Number(u.cost);let f=null,d=1;u.sap_master_file&&(f=u.sap_master_file.BaseUOM,d=Number(u.sap_master_file.BaseQty)||1),n.base_uom=f,n.base_qty=d}else _.add({severity:"error",summary:"Error",detail:"Item details not found.",life:5e3})}catch{_.add({severity:"error",summary:"Error",detail:"Failed to load item details.",life:5e3})}finally{O.value=!1}}else Object.keys(n).forEach(e=>n[e]=null)},{deep:!0}),q(()=>a.supplier_id,async s=>{if(!(!E.value&&!D.value)){if(a.order_date=null,a.branch_id=null,L.value={},V.value=null,Object.keys(n).forEach(e=>n[e]=null),Y(s),$.value=[],!s){U.value=!0;return}U.value=!0;try{const e=await A.get(route("store-orders.available-dates",{supplier_code:s}));$.value=e.data,U.value=!1}catch{_.add({severity:"error",summary:"Error",detail:"Failed to load available dates.",life:5e3})}}}),q(()=>a.order_date,async s=>{if(!(!E.value&&!D.value))if(a.branch_id=null,s&&a.supplier_id)try{const e=await A.get(route("store-orders.get-branches",{order_date:s,supplier_code:a.supplier_id}));L.value=e.data}catch(e){console.error("Error fetching branches:",e),_.add({severity:"error",summary:"Error",detail:"Failed to load store branches for the selected date.",life:5e3})}else L.value={}});const ve=j(()=>!!a.supplier_id),H=j(()=>a.orders.length>0),_e=j(()=>a.orders.reduce((s,e)=>s+parseFloat(e.total_cost),0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}));return(s,e)=>{const u=p("CardTitle"),f=p("CardDescription"),d=p("CardHeader"),b=p("InputLabel"),g=p("FormError"),y=p("CardContent"),F=p("Card"),h=p("Label"),B=p("Input"),R=p("Button"),J=p("CardFooter"),ye=p("LabelXS"),be=p("SpanBold"),W=p("DivFlexCenter"),x=p("TH"),ge=p("TableHead"),C=p("TD"),xe=p("TableBody"),Ce=p("Table"),De=p("Layout");return I(),qe(De,{heading:"Store Order > Create"},{default:l(()=>[i("div",Ne,[i("section",Ee,[t(F,null,{default:l(()=>[t(d,null,{default:l(()=>[t(u,null,{default:l(()=>e[9]||(e[9]=[o("Order Details")])),_:1}),t(f,null,{default:l(()=>e[10]||(e[10]=[o("Please input all the fields")])),_:1})]),_:1}),t(y,{class:"space-y-3"},{default:l(()=>[i("div",Le,[t(b,{label:"Supplier"}),t(m(z),{filter:"",placeholder:"Select a Supplier",modelValue:m(a).supplier_id,"onUpdate:modelValue":e[0]||(e[0]=r=>m(a).supplier_id=r),options:m(se),optionLabel:"label",optionValue:"value",disabled:H.value},null,8,["modelValue","options","disabled"]),t(g,null,{default:l(()=>[o(c(m(a).errors.supplier_id),1)]),_:1})]),i("div",Me,[t(b,{label:"Order Date"}),i("div",{class:"relative",ref_key:"dateInputRef",ref:Q},[i("div",Ue,[i("input",{id:"order_date",type:"text",readonly:"",value:m(a).order_date,onClick:e[1]||(e[1]=r=>k.value=!k.value),disabled:U.value||H.value,class:"flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-gray-400 disabled:cursor-not-allowed disabled:opacity-50 cursor-pointer",placeholder:"Select a date"},null,8,je),t(m(Be),{class:"absolute right-3 top-1/2 -translate-y-1/2 size-4 text-gray-500 pointer-events-none"})]),Ie(i("div",{class:K(["absolute z-50 bg-white border border-gray-200 rounded-lg shadow-lg p-4 w-full min-w-[300px]",P.value])},[i("div",Ae,[i("button",{type:"button",onClick:e[2]||(e[2]=Z(r=>ie(),["stop"])),class:"p-2 rounded-full hover:bg-gray-100"},"<"),i("h2",$e,c(S.value.toLocaleString("default",{month:"long",year:"numeric"})),1),i("button",{type:"button",onClick:e[3]||(e[3]=Z(r=>ue(),["stop"])),class:"p-2 rounded-full hover:bg-gray-100"},">")]),e[11]||(e[11]=i("div",{class:"grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-500 mb-2"},[i("span",null,"Su"),i("span",null,"Mo"),i("span",null,"Tu"),i("span",null,"We"),i("span",null,"Th"),i("span",null,"Fr"),i("span",null,"Sa")],-1)),i("div",Qe,[(I(!0),T(te,null,ee(ne(),(r,X)=>(I(),T("div",{key:X,class:K(["text-center py-1.5 rounded-full text-sm",[r?r.isDisabled?"text-gray-300 line-through cursor-not-allowed":m(a).order_date&&r.date.toDateString()===new Date(m(a).order_date+"T00:00:00").toDateString()?"bg-blue-600 text-white font-bold shadow-md":"bg-gray-100 text-gray-800 font-semibold cursor-pointer hover:bg-blue-100":""]]),onClick:Ze=>de(r)},c(r?r.day:""),11,Pe))),128))])],2),[[he,k.value]])],512),t(g,null,{default:l(()=>[o(c(m(a).errors.order_date),1)]),_:1})]),i("div",He,[t(b,{label:"Store Branch"}),t(m(z),{filter:"",placeholder:"Select a Store",modelValue:m(a).branch_id,"onUpdate:modelValue":e[4]||(e[4]=r=>m(a).branch_id=r),options:re.value,optionLabel:"label",optionValue:"value",disabled:H.value},null,8,["modelValue","options","disabled"]),t(g,null,{default:l(()=>[o(c(m(a).errors.branch_id),1)]),_:1})])]),_:1})]),_:1}),t(F,null,{default:l(()=>[t(d,null,{default:l(()=>[t(u,null,{default:l(()=>e[12]||(e[12]=[o("Add Item")])),_:1}),t(f,null,{default:l(()=>e[13]||(e[13]=[o("Please input all the fields")])),_:1})]),_:1}),t(y,{class:"space-y-3"},{default:l(()=>[i("div",Re,[t(h,null,{default:l(()=>e[14]||(e[14]=[o("Item")])),_:1}),t(m(z),{filter:"",placeholder:"Select an Item",modelValue:V.value,"onUpdate:modelValue":e[5]||(e[5]=r=>V.value=r),options:M.value,optionLabel:"label",optionValue:"value",disabled:!ve.value||O.value},{empty:l(()=>[O.value?(I(),T("div",ze,"Loading items...")):(I(),T("div",Ye,"No items available for this supplier."))]),_:1},8,["modelValue","options","disabled"]),t(g,null,{default:l(()=>[o(c(m(w).errors.item),1)]),_:1})]),i("div",Je,[t(h,null,{default:l(()=>e[15]||(e[15]=[o("Unit Of Measurement (UOM)")])),_:1}),t(B,{type:"text",disabled:"",modelValue:n.unit_of_measurement,"onUpdate:modelValue":e[6]||(e[6]=r=>n.unit_of_measurement=r)},null,8,["modelValue"])]),i("div",We,[t(h,null,{default:l(()=>e[16]||(e[16]=[o("Cost")])),_:1}),t(B,{type:"text",disabled:"",modelValue:n.cost,"onUpdate:modelValue":e[7]||(e[7]=r=>n.cost=r)},null,8,["modelValue"])]),i("div",Xe,[t(h,null,{default:l(()=>e[17]||(e[17]=[o("Quantity")])),_:1}),t(B,{type:"number",modelValue:n.quantity,"onUpdate:modelValue":e[8]||(e[8]=r=>n.quantity=r)},null,8,["modelValue"]),t(g,null,{default:l(()=>[o(c(m(w).errors.quantity),1)]),_:1})])]),_:1}),t(J,{class:"flex justify-end"},{default:l(()=>[t(R,{onClick:ce,disabled:O.value},{default:l(()=>e[18]||(e[18]=[o("Add to Orders")])),_:1},8,["disabled"])]),_:1})]),_:1})]),t(F,{class:"col-span-2 flex flex-col"},{default:l(()=>[t(d,{class:"flex justify-between"},{default:l(()=>[t(W,{class:"justify-between"},{default:l(()=>[t(u,null,{default:l(()=>e[19]||(e[19]=[o("Items List")])),_:1}),t(W,{class:"gap-2"},{default:l(()=>[t(ye,null,{default:l(()=>e[20]||(e[20]=[o(" Overall Total:")])),_:1}),t(be,null,{default:l(()=>[o(c(_e.value),1)]),_:1}),t(R,{onClick:pe,variant:"outline",class:"text-red-500",disabled:m(a).orders.length===0},{default:l(()=>[t(m(le),{class:"size-4 mr-1"}),e[21]||(e[21]=o(" Delete All "))]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}),t(y,{class:"flex-1"},{default:l(()=>[i("div",Ge,[t(Ce,null,{default:l(()=>[t(ge,null,{default:l(()=>[t(x,null,{default:l(()=>e[22]||(e[22]=[o("Name")])),_:1}),e[31]||(e[31]=o()),t(x,null,{default:l(()=>e[23]||(e[23]=[o("Code")])),_:1}),e[32]||(e[32]=o()),t(x,null,{default:l(()=>e[24]||(e[24]=[o("Ordered Qty")])),_:1}),e[33]||(e[33]=o()),t(x,null,{default:l(()=>e[25]||(e[25]=[o("Unit")])),_:1}),e[34]||(e[34]=o()),t(x,null,{default:l(()=>e[26]||(e[26]=[o("BaseUOM Qty")])),_:1}),e[35]||(e[35]=o()),t(x,null,{default:l(()=>e[27]||(e[27]=[o("Base UOM")])),_:1}),e[36]||(e[36]=o()),t(x,null,{default:l(()=>e[28]||(e[28]=[o("Cost")])),_:1}),e[37]||(e[37]=o()),t(x,null,{default:l(()=>e[29]||(e[29]=[o("Total Cost")])),_:1}),e[38]||(e[38]=o()),t(x,null,{default:l(()=>e[30]||(e[30]=[o("Action")])),_:1})]),_:1}),t(xe,null,{default:l(()=>[(I(!0),T(te,null,ee(m(a).orders,r=>(I(),T("tr",{key:r.id},[t(C,null,{default:l(()=>[o(c(r.name),1)]),_:2},1024),t(C,null,{default:l(()=>[o(c(r.inventory_code),1)]),_:2},1024),t(C,null,{default:l(()=>[o(c(r.quantity),1)]),_:2},1024),t(C,null,{default:l(()=>[o(c(r.unit_of_measurement),1)]),_:2},1024),t(C,null,{default:l(()=>[o(c(r.base_uom_qty),1)]),_:2},1024),t(C,null,{default:l(()=>[o(c(r.base_uom),1)]),_:2},1024),t(C,null,{default:l(()=>[o(c(Number(r.cost).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1)]),_:2},1024),t(C,null,{default:l(()=>[o(c(Number(r.total_cost).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})),1)]),_:2},1024),t(C,{class:"flex gap-3"},{default:l(()=>[i("button",{onClick:X=>me(r.id),variant:"outline",class:"text-red-500 size-5"},[t(m(le))],8,Ke)]),_:2},1024)]))),128))]),_:1})]),_:1})])]),_:1}),t(J,{class:"flex justify-end"},{default:l(()=>[t(R,{onClick:fe},{default:l(()=>e[39]||(e[39]=[o("Place Order")])),_:1})]),_:1})]),_:1})])]),_:1})}}};export{ot as default};
