import{Y as Ae,f as Ne,x as N,T as Te,y as qe,l as j,r as y,o as r,c as w,w as o,a,g as u,b as i,t as d,n as Y,u as f,h as _,d as v,e as O,m as J,A as B,X as ee,ay as te,F as W,k as se,N as z}from"./app-p8ycGfai.js";import{u as Fe}from"./useBackButton-DYna6UI2.js";import{u as Le}from"./useToast-BAk2IYqi.js";import{u as Se}from"./useAuth-CsB0rIGq.js";import{S as ae}from"./save-CTh84Lhv.js";import{S as le}from"./square-pen-CI0P5sG9.js";import{P as Me}from"./paperclip--9WRFhz4.js";import{L as Be}from"./loader-circle-PEkmcZqs.js";import{C as Ee}from"./circle-alert-DTQS8jZO.js";const $e={class:"flex flex-col gap-5"},Ue={class:"sm:flex-row flex flex-col gap-5"},Pe={class:"text-gray-700 text-sm"},Ve={class:"font-bold"},ze={class:"text-gray-700 text-sm"},Ge={class:"font-bold"},Re={class:"sm:flex-row flex flex-col gap-5"},je={class:"text-gray-700 text-sm"},Oe={class:"text-gray-700 text-sm"},We={class:"font-bold"},He={class:"sm:flex-row flex flex-col gap-5"},Qe={class:"text-gray-700 text-sm"},Ke={class:"font-bold"},Xe={key:0},Ze={key:1,class:"flex items-center gap-4"},Ye={key:0},Je={key:0},et={key:1,class:"flex items-center gap-2"},tt={key:0,class:"flex justify-end mt-2"},st={key:0,class:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"},at={class:"px-4 sm:px-6 py-4 bg-gradient-to-r from-blue-50 to-blue-100 border-b border-blue-200"},lt={class:"flex items-center gap-3"},ot={class:"p-4 sm:p-6"},rt={class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"},nt=["onClick","onKeydown","aria-label"],it={class:"aspect-w-1 aspect-h-1"},ut={key:0,class:"absolute inset-0 bg-gray-100 rounded-lg flex items-center justify-center"},dt={key:1,class:"absolute inset-0 bg-red-50 rounded-lg flex flex-col items-center justify-center p-4"},ct={class:"text-xs text-red-700 text-center mb-2"},pt={key:0,class:"text-xs text-gray-600 mb-2"},vt={class:"flex gap-2"},ft=["onClick"],gt={key:0,class:"text-xs text-gray-500"},yt=["src","alt","onLoad","onError","onLoadstart"],mt={key:0,class:"absolute bottom-1 left-1 bg-black bg-opacity-75 text-white text-xs p-1 rounded max-w-full truncate pointer-events-none"},_t={key:0,class:"block text-yellow-300"},bt={key:1,class:"absolute top-1 left-1 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"},xt={__name:"Show",props:{wastage:{type:Object,required:!0},permissions:{type:Object,required:!0}},setup(g){const G=Ne(),{toast:T}=Le(),{hasAccess:L}=Se(),{backButton:oe}=Fe(route("wastage-approval-lvl1.index")),q=g,re=t=>t?new Date(t).toLocaleDateString("en-PH",{year:"numeric",month:"short",day:"numeric"}):"N/A",ne=t=>{var e,l,n;return t.store_branch_name||((e=t.storeBranch)==null?void 0:e.name)||((l=t.storeBranch)==null?void 0:l.branch_name)||((n=t.storeBranch)==null?void 0:n.brand_name)||"Unknown Store"},ie=t=>{switch(t.toUpperCase()){case"APPROVED_LVL1":return"bg-blue-500 text-white";case"PENDING":return"bg-yellow-500 text-white";case"CANCELLED":return"bg-red-500 text-white";default:return"bg-gray-500 text-white"}},S=N(!1),h=N(null),D=N("");N(null);const H={mounted:t=>{const e=t.tagName==="INPUT"?t:t.querySelector("input");e&&(e.focus(),e.select())}},E=Te({order_id:null,remarks:null}),ue=t=>{G.require({message:"Are you sure you want to approve this wastage record?",header:"Confirmation",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Cancel",severity:"secondary",outlined:!0},acceptProps:{label:"Confirm",severity:"info"},accept:()=>{S.value=!0,E.order_id=t,E.post(route("wastage-approval-lvl1.approve"),{onSuccess:()=>{T.add({severity:"success",summary:"Success",detail:"Wastage record approved successfully.",life:3e3}),z.get(route("wastage-approval-lvl1.index"),{},{replace:!0})},onError:()=>{S.value=!1}})}})},de=t=>{G.require({message:"Are you sure you want to cancel this wastage record?",header:"Confirmation",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Cancel",severity:"secondary",outlined:!0},acceptProps:{label:"Confirm",severity:"danger"},accept:()=>{S.value=!0,E.order_id=t,E.post(route("wastage-approval-lvl1.cancel"),{onSuccess:()=>{T.add({severity:"success",summary:"Success",detail:"Wastage record cancelled successfully.",life:3e3}),z.get(route("wastage-approval-lvl1.index"),{},{replace:!0})},onError:()=>{S.value=!1}})}})},M=N([]);qe(()=>q.wastage,t=>{t&&t.items&&(M.value=t.items.map(e=>{var l,n,c;return{id:e.id,wastage_qty:e.wastage_qty,approverlvl1_qty:e.approverlvl1_qty??e.wastage_qty,item_code:(l=e.sap_masterfile)==null?void 0:l.ItemCode,description:(n=e.sap_masterfile)==null?void 0:n.ItemDescription,cost:e.cost,uom:(c=e.sap_masterfile)==null?void 0:c.BaseUOM}}))},{immediate:!0,deep:!0});const Q=t=>{const e=M.value.find(l=>l.id===t);e&&(h.value={id:t,originalValue:e.approverlvl1_qty},D.value=e.approverlvl1_qty.toString())},$=()=>{if(!h.value)return;const t=parseFloat(D.value);if(isNaN(t)||t<0){T.add({severity:"error",summary:"Error",detail:"Please enter a valid quantity.",life:3e3});return}const e=Number(t.toFixed(2)),l=h.value.id,n=h.value.originalValue,c=M.value.find(A=>A.id===l);c&&(c.approverlvl1_qty=e),ce(l,e,n),h.value=null,D.value=""},U=()=>{h.value=null,D.value=""},ce=(t,e,l)=>{z.post(route("wastage-approval-lvl1.update-quantity",t),{approverlvl1_qty:e},{preserveScroll:!0,onSuccess:()=>{T.add({severity:"success",summary:"Success",detail:"Quantity updated successfully.",life:2e3})},onError:n=>{const c=M.value.find(b=>b.id===t);c&&(c.approverlvl1_qty=l);const A=n.approverlvl1_qty||n.message||"Failed to update quantity. Please refresh the page.";T.add({severity:"error",summary:"Error",detail:A,life:3e3})}})},K=t=>{G.require({message:"Are you sure you want to delete this item?",header:"Confirmation",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Cancel",severity:"secondary",outlined:!0},acceptProps:{label:"Delete",severity:"danger"},accept:()=>{z.delete(route("wastage-approval-lvl1.destroy-item",t),{preserveScroll:!0,onSuccess:()=>{T.add({severity:"success",summary:"Success",detail:"Item deleted successfully.",life:3e3})},onError:e=>{const l=Object.values(e).join(" ");T.add({severity:"error",summary:"Error",detail:l||"Failed to delete item.",life:3e3})}})}})},k=N({}),x=N({}),C=N({}),pe=(t,e=0)=>{if(!t)return{url:"",isGoogleDrive:!1,hasMoreFallbacks:!1};if(t.includes("drive.google.com"))try{let l=null;if(t.includes("/file/d/")){const n=t.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);n&&(l=n[1])}else if(t.includes("open?id=")){const n=t.match(/[?&]id=([a-zA-Z0-9_-]+)/);n&&(l=n[1])}if(l){const n=[`/proxy/google-drive/${l}`,`https://drive.google.com/thumbnail?id=${l}&sz=s400`,`https://drive.google.com/uc?export=view&id=${l}`,`https://drive.google.com/uc?export=download&id=${l}`,`https://docs.google.com/uc?export=view&id=${l}`,`https://lh3.googleusercontent.com/d/${l}=s400`];return e<n.length?{url:n[e],isGoogleDrive:!0,hasMoreFallbacks:e<n.length-1,fileId:l,attemptIndex:e,totalFormats:n.length,allFormats:n}:{url:"",isGoogleDrive:!0,hasMoreFallbacks:!1,fileId:l}}}catch(l){console.error("Error transforming Google Drive URL:",l,"URL:",t)}return{url:t,isGoogleDrive:!1,hasMoreFallbacks:!1}},X=j(()=>{var l,n;let t=[];return(l=q.wastage)!=null&&l.image_urls&&Array.isArray(q.wastage.image_urls)&&q.wastage.image_urls.length>0?t=q.wastage.image_urls:(n=q.wastage)!=null&&n.image_url&&(t=[q.wastage.image_url]),t.map(c=>{C.value[c]===void 0&&(C.value[c]=0);const A=C.value[c],b=pe(c,A);return{type:"existing",url:b.url,id:c,originalUrl:c,urlInfo:b,attemptIndex:A}})}),ve=j(()=>X.value.length>0),fe=j(()=>{try{return!1}catch(t){return console.warn("Could not determine development mode:",t),!1}}),ge=t=>{k.value[t]=!1,x.value[t]=null,C.value[t]=0},ye=(t,e)=>{if(e.urlInfo&&e.urlInfo.isGoogleDrive&&e.urlInfo.hasMoreFallbacks){const l=(C.value[t]||0)+1;C.value[t]=l;return}k.value[t]=!1,e.urlInfo&&e.urlInfo.isGoogleDrive?x.value[t]=`Failed to load image after trying ${e.urlInfo.totalFormats} different URL formats. The Google Drive file may not be publicly accessible or may have been deleted.`:x.value[t]="Failed to load image. The URL may be invalid or the image may not be accessible."},me=t=>{const e=t.id;k.value[e]=!0,x.value[e]=null},_e=t=>{t.urlInfo&&t.urlInfo.isGoogleDrive&&t.urlInfo.hasMoreFallbacks?(C.value[t.id]=(C.value[t.id]||0)+1,x.value[t.id]=null,k.value[t.id]=!0):(C.value[t.id]=0,x.value[t.id]=null,k.value[t.id]=!0)},R=(t,e)=>{k.value[t.id]||x.value[t.id]||window.open(t.url,"_blank")};return(t,e)=>{const l=y("Badge"),n=y("Button"),c=y("DivFlexCenter"),A=y("TableHeader"),b=y("TH"),be=y("TableHead"),F=y("TD"),Z=y("Input"),xe=y("TableBody"),we=y("Table"),he=y("MobileTableHeading"),P=y("LabelXS"),ke=y("MobileTableRow"),Ce=y("MobileTableContainer"),Ie=y("TableContainer"),De=y("Layout");return r(),w(De,{heading:"Wastage Record Details"},{default:o(()=>[a(Ie,null,{default:o(()=>[u("section",$e,[u("section",Ue,[u("span",Pe,[e[4]||(e[4]=i(" Wastage Number: ")),u("span",Ve,d(g.wastage.wastage_no),1)]),u("span",ze,[e[5]||(e[5]=i(" Store: ")),u("span",Ge,d(ne(g.wastage)),1)])]),u("section",Re,[u("span",je,[e[6]||(e[6]=i(" Status: ")),a(l,{class:Y([ie(g.wastage.wastage_status),"font-bold"])},{default:o(()=>{var s;return[i(d(((s=g.wastage.wastage_status)==null?void 0:s.toUpperCase().replace("_"," "))??"N/A"),1)]}),_:1},8,["class"])]),u("span",Oe,[e[7]||(e[7]=i(" Date: ")),u("span",We,d(re(g.wastage.created_at)),1)])]),u("section",He,[u("span",Qe,[e[8]||(e[8]=i(" Remarks: ")),u("span",Ke,d(g.wastage.remarks??"No remarks provided"),1)])]),a(c,{class:"gap-5"},{default:o(()=>[g.wastage.wastage_status==="pending"&&f(L)("cancel wastage approval level 1")?(r(),w(n,{key:0,variant:"destructive",onClick:e[0]||(e[0]=s=>de(g.wastage.id)),disabled:S.value},{default:o(()=>e[9]||(e[9]=[i(" Cancel Wastage ")])),_:1},8,["disabled"])):_("",!0),g.wastage.wastage_status==="pending"&&f(L)("approve wastage level 1")?(r(),w(n,{key:1,class:"bg-green-500 hover:bg-green-300",onClick:e[1]||(e[1]=s=>ue(g.wastage.id)),disabled:S.value},{default:o(()=>e[10]||(e[10]=[i(" Approve Wastage ")])),_:1},8,["disabled"])):_("",!0)]),_:1})]),a(A),a(we,null,{default:o(()=>[a(be,null,{default:o(()=>[a(b,null,{default:o(()=>e[11]||(e[11]=[i(" Item Code ")])),_:1}),a(b,null,{default:o(()=>e[12]||(e[12]=[i(" Description ")])),_:1}),a(b,null,{default:o(()=>e[13]||(e[13]=[i(" Reason ")])),_:1}),a(b,null,{default:o(()=>e[14]||(e[14]=[i(" UOM ")])),_:1}),a(b,null,{default:o(()=>e[15]||(e[15]=[i(" Wastage Qty ")])),_:1}),g.wastage.wastage_status==="pending"?(r(),w(b,{key:0},{default:o(()=>e[16]||(e[16]=[i("Approved Qty")])),_:1})):(r(),w(b,{key:1},{default:o(()=>e[17]||(e[17]=[i("Approved Qty")])),_:1}))]),_:1}),a(xe,null,{default:o(()=>[(r(!0),v(W,null,O(g.wastage.items,s=>(r(),v("tr",{key:s.id},[a(F,null,{default:o(()=>{var p;return[i(d(((p=s.sap_masterfile)==null?void 0:p.ItemCode)||"N/A"),1)]}),_:2},1024),a(F,null,{default:o(()=>{var p;return[i(d(((p=s.sap_masterfile)==null?void 0:p.ItemDescription)||"N/A"),1)]}),_:2},1024),a(F,{class:"text-sm"},{default:o(()=>[i(d(s.reason||"No reason specified"),1)]),_:2},1024),a(F,null,{default:o(()=>{var p,m;return[i(d((((p=s.sap_masterfile)==null?void 0:p.AltUOM)||((m=s.sap_masterfile)==null?void 0:m.BaseUOM))??"N/A"),1)]}),_:2},1024),a(F,null,{default:o(()=>[i(d(s.wastage_qty),1)]),_:2},1024),g.wastage.wastage_status==="pending"?(r(),w(F,{key:0,class:"flex items-center gap-3"},{default:o(()=>{var p;return[h.value&&h.value.id===s.id?(r(),v("div",Xe,[J(a(Z,{type:"number",modelValue:D.value,"onUpdate:modelValue":e[2]||(e[2]=m=>D.value=m),class:"w-20 text-right",onKeyup:[B($,["enter"]),B(U,["esc"])]},null,8,["modelValue"]),[[H]]),a(c,{class:"gap-1 ml-2"},{default:o(()=>[a(f(ae),{class:"size-4 text-green-500 cursor-pointer hover:text-green-600",onClick:$}),a(f(ee),{class:"size-4 text-red-500 cursor-pointer hover:text-red-600",onClick:U})]),_:1})])):(r(),v("div",Ze,[i(d(((p=M.value.find(m=>m.id===s.id))==null?void 0:p.approverlvl1_qty)??0)+" ",1),f(L)("edit wastage approval level 1")?(r(),w(f(le),{key:0,class:"size-4 text-blue-500 cursor-pointer hover:text-blue-600",onClick:m=>Q(s.id)},null,8,["onClick"])):_("",!0),f(L)("delete wastage approval level 1")?(r(),w(f(te),{key:1,class:"size-4 text-red-500 cursor-pointer hover:text-red-600",onClick:m=>K(s.id)},null,8,["onClick"])):_("",!0)]))]}),_:2},1024)):(r(),w(F,{key:1},{default:o(()=>[i(d(s.approverlvl1_qty),1)]),_:2},1024))]))),128))]),_:1})]),_:1}),a(Ce,null,{default:o(()=>[(r(!0),v(W,null,O(g.wastage.items,s=>(r(),w(ke,{key:s.id},{default:o(()=>{var p,m;return[a(he,{title:`${((p=s.sap_masterfile)==null?void 0:p.ItemDescription)||"N/A"} (${((m=s.sap_masterfile)==null?void 0:m.ItemCode)||"N/A"})`},{default:o(()=>[g.wastage.wastage_status==="pending"&&f(L)("edit wastage approval level 1")?(r(),v("div",Ye,[h.value&&h.value.id===s.id?(r(),v("div",Je,[J(a(Z,{type:"number",modelValue:D.value,"onUpdate:modelValue":e[3]||(e[3]=I=>D.value=I),class:"w-20 text-right",onKeyup:[B($,["enter"]),B(U,["esc"])]},null,8,["modelValue"]),[[H]]),a(c,{class:"gap-1 ml-2"},{default:o(()=>[a(f(ae),{class:"size-4 text-green-500 cursor-pointer hover:text-green-600",onClick:$}),a(f(ee),{class:"size-4 text-red-500 cursor-pointer hover:text-red-600",onClick:U})]),_:1})])):(r(),v("div",et,[a(f(le),{class:"size-4 text-blue-500 cursor-pointer hover:text-blue-600",onClick:I=>Q(s.id)},null,8,["onClick"])]))])):_("",!0)]),_:2},1032,["title"]),a(P,null,{default:o(()=>[i("Reason: "+d(s.reason||"No reason specified"),1)]),_:2},1024),a(P,null,{default:o(()=>{var I,V;return[i("UOM: "+d((((I=s.sap_masterfile)==null?void 0:I.AltUOM)||((V=s.sap_masterfile)==null?void 0:V.BaseUOM))??"N/A"),1)]}),_:2},1024),a(P,null,{default:o(()=>[i("Wastage: "+d(s.wastage_qty),1)]),_:2},1024),a(P,null,{default:o(()=>{var I;return[i(" Approved: "+d(((I=M.value.find(V=>V.id===s.id))==null?void 0:I.approverlvl1_qty)??0),1)]}),_:2},1024),g.wastage.wastage_status==="pending"?(r(),v("div",tt,[f(L)("delete wastage approval level 1")?(r(),w(f(te),{key:0,class:"size-4 text-red-500 cursor-pointer hover:text-red-600",onClick:I=>K(s.id)},null,8,["onClick"])):_("",!0)])):_("",!0)]}),_:2},1024))),128))]),_:1})]),_:1}),ve.value?(r(),v("div",st,[u("div",at,[u("div",lt,[a(f(Me),{class:"w-5 h-5 text-blue-600"}),e[18]||(e[18]=u("h3",{class:"text-lg font-semibold text-gray-900"},"Attached Images",-1))])]),u("div",ot,[u("div",rt,[(r(!0),v(W,null,O(X.value,(s,p)=>(r(),v("div",{key:s.id,class:Y(["relative group cursor-pointer",{"cursor-zoom-in":!k.value[s.id]&&!x.value[s.id]}]),onClick:m=>R(s,p),onKeydown:[B(m=>R(s,p),["enter"]),B(se(m=>R(s,p),["prevent"]),["space"])],tabindex:"0",role:"button","aria-label":`View image ${p+1} in new tab`},[u("div",it,[k.value[s.id]?(r(),v("div",ut,[a(f(Be),{class:"w-8 h-8 text-blue-600 animate-spin"})])):x.value[s.id]?(r(),v("div",dt,[a(f(Ee),{class:"w-8 h-8 text-red-500 mb-2"}),u("p",ct,d(x.value[s.id]),1),s.urlInfo&&s.urlInfo.isGoogleDrive?(r(),v("p",pt," Tried "+d(s.urlInfo.totalFormats)+" URL formats ",1)):_("",!0),u("div",vt,[u("button",{onClick:se(m=>_e(s),["stop"]),class:"text-xs text-blue-600 hover:text-blue-800 underline"},d(s.urlInfo&&s.urlInfo.isGoogleDrive&&s.urlInfo.hasMoreFallbacks?"Try Next URL":"Retry"),9,ft),s.urlInfo&&s.urlInfo.isGoogleDrive&&s.urlInfo.hasMoreFallbacks?(r(),v("span",gt," ("+d(s.urlInfo.totalFormats-(s.attemptIndex+1))+" left) ",1)):_("",!0)])])):(r(),v("img",{key:2,src:s.url,alt:`Wastage Image ${p+1}`,class:"object-cover shadow-lg rounded-lg w-full h-full hover:opacity-90 transition-opacity",onLoad:()=>ge(s.id),onError:()=>ye(s.id,s),onLoadstart:()=>me(s)},null,40,yt))]),fe.value?(r(),v("div",mt,[i(d(s.type==="existing"?"Existing":"New")+" ",1),s.type==="existing"?(r(),v("span",_t,"ID: "+d(s.id.substring(0,10))+"...",1)):_("",!0)])):_("",!0),!k.value[s.id]&&!x.value[s.id]?(r(),v("div",bt," Click to view ")):_("",!0)],42,nt))),128))])])])):_("",!0),a(n,{variant:"outline",class:"text-lg px-7",onClick:f(oe)},{default:o(()=>e[19]||(e[19]=[i(" Back ")])),_:1},8,["onClick"])]),_:1})}}},qt=Ae(xt,[["__scopeId","data-v-524d5d1c"]]);export{qt as default};
