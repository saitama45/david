import{f as fe,x as f,Q as i,y as F,N,l as me,T as _e,V as ve,r as n,o as $,c as be,w as s,a as t,d as O,g as d,u as l,b as r,t as b,h as R,R as xe,aj as A,_ as B,i as H,e as ge,F as we,ay as ye}from"./app-Bw_fMWAP.js";import{d as U,_ as z,a as W,b as X,e as q,c as Se}from"./DialogTitle-Cz47cJZ9.js";import"./lodash-Cj3gZpb5.js";import{u as he}from"./useToast-CgNL_wIh.js";import{u as Ie}from"./useSelectOptions-BcktnHf_.js";import{T as Q}from"./triangle-alert-Dth29Wrv.js";import{X as Te}from"./x-CdvG2xaQ.js";const ke={key:0,class:"relative mx-auto w-full max-w-4xl bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg shadow-lg mb-4 mt-4",role:"alert"},Ce={class:"flex items-center justify-between mb-2"},De={class:"font-bold flex items-center"},Ne={class:"max-h-40 overflow-y-auto pr-2"},$e={class:"text-sm whitespace-pre-line"},Ve={class:"flex items-center justify-center flex-col"},Fe={class:"text-center"},Oe={class:"flex justify-end"},Le={key:0},He={__name:"MainIndex",props:{transactions:{type:Object,required:!0},branches:{type:Object,required:!0}},setup(L){const{toast:T}=he();fe();const{options:M}=Ie(L.branches);let k=f(i().props.filters.search),c=f(i().props.filters.from??new Date().toISOString().slice(0,10)),p=f(i().props.filters.to??new Date().toISOString().slice(0,10));const m=f(i().props.filters.branchId??"all");F(c,o=>{N.get(route("store-transactions.main-index"),{search:k.value,from:o,to:p.value,branchId:m.value},{preserveState:!0,preserveScroll:!0})}),F(p,o=>{N.get(route("store-transactions.main-index"),{search:k.value,from:c.value,to:o,branchId:m.value},{preserveState:!0,preserveScroll:!0})}),F(m,o=>{N.get(route("store-transactions.main-index"),{search:k.value,from:c.value,to:p.value,branchId:o},{preserveState:!0,preserveScroll:!0})});const Y=()=>{c.value=new Date().toISOString().slice(0,10),p.value=new Date().toISOString().slice(0,10),m.value="all",k.value=null,N.get(route("store-transactions.main-index"),{search:k.value,from:c.value,to:p.value,branchId:m.value},{preserveState:!0,preserveScroll:!0,replace:!0})},G=me(()=>route("store-transactions.export-main-index",{branchId:m.value,from:c.value,to:p.value})),C=_e({store_transactions_file:null}),_=f(!1),x=f(!1),J=()=>{x.value=!0};F(x,o=>{o||(_.value=!1,C.reset())});const j=f(!1),V=f(""),D=f([]),g=f(""),E=o=>{if(!o||o.length===0)return"";const e={};o.forEach(u=>{const v=u.data&&u.data.product_id?u.data.product_id:"N/A",y=u.reason||"Unknown reason",S=`${v}-${y}`;e[S]||(e[S]={productId:v,reason:y,count:0,rowNumbers:[]}),e[S].count++,e[S].rowNumbers.push(u.row_number)});let w=`The following import warnings occurred:

`;return Object.values(e).forEach(u=>{const v=u.productId!=="N/A"?` (Product ID: ${u.productId})`:"",y=u.rowNumbers.length>5?`${u.rowNumbers.slice(0,5).join(", ")}... (and ${u.rowNumbers.length-5} more)`:u.rowNumbers.join(", ");w+=`- ${u.reason}${v}. Occurrences: ${u.count} (Rows: ${y})
`}),w},K=()=>{_.value=!0,C.post(route("store-transactions.import"),{onSuccess:()=>{_.value=!1,x.value=!1;const o=i().props.flash;console.log("onSuccess: flash object from Inertia:",o),o.skipped_import_rows&&o.skipped_import_rows.length>0?(D.value=o.skipped_import_rows,g.value=E(D.value),T.add({severity:"warn",summary:"Import Completed with Warnings",detail:o.warning||"Some transactions were skipped during import. See message below for details.",life:5e3})):o.success&&(g.value="",T.add({severity:"success",summary:"Success",detail:o.success,life:3e3})),i().props.flash.skipped_import_rows=null,i().props.flash.warning=null,i().props.flash.success=null,i().props.flash.error=null,N.reload({preserveState:!0})},onError:o=>{_.value=!1,x.value=!1;const e=i().props.flash;e.error?V.value=e.error:o.store_transactions_file?V.value=o.store_transactions_file[0]:V.value="An unknown error occurred during import.",j.value=!0,i().props.flash.error=null},onFinish:()=>{_.value=!1}})},Z=o=>{if(!o)return"N/a";try{const e=new Date(o),w=String(e.getMonth()+1).padStart(2,"0"),u=String(e.getDate()).padStart(2,"0"),v=e.getFullYear();return`${w}/${u}/${v}`}catch(e){return console.error("Error formatting date:",o,e),o}};ve(()=>{const o=i().props.flash;console.log("onMounted: Full flash object from Inertia:",o),console.log("onMounted: branchesOptions:",M.value),console.log("onMounted: initial branchId.value:",m.value),o.skipped_import_rows&&o.skipped_import_rows.length>0?(D.value=o.skipped_import_rows,g.value=E(D.value),o.warning&&T.add({severity:"warn",summary:"Import Warning",detail:o.warning,life:5e3})):o.success?T.add({severity:"success",summary:"Success",detail:o.success,life:3e3}):o.error&&T.add({severity:"error",summary:"Import Error",detail:o.error,life:5e3}),i().props.flash.skipped_import_rows=null,i().props.flash.warning=null,i().props.flash.success=null,i().props.flash.error=null});const ee=()=>{g.value="",D.value=[]};return(o,e)=>{const w=n("Select"),u=n("Filter"),v=n("PopoverTrigger"),y=n("PopoverContent"),S=n("Popover"),te=n("DivFlexCenter"),oe=n("TableHeader"),h=n("TH"),se=n("TableHead"),I=n("TD"),le=n("ShowButton"),ae=n("TableBody"),ne=n("Table"),re=n("Pagination"),ue=n("TableContainer"),ie=n("LabelXS"),de=n("FormError"),P=n("InputContainer"),ce=n("Loading"),pe=n("Layout");return $(),be(pe,{heading:"Store Transactions",hasButton:!0,buttonName:"Import Store Transactions",handleClick:J,hasExcelDownload:!0,exportRoute:G.value},{default:s(()=>[t(xe,{"enter-active-class":"transition ease-out duration-200","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-150","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:s(()=>[g.value?($(),O("div",ke,[d("div",Ce,[d("strong",De,[t(l(Q),{class:"size-5 mr-2"}),e[6]||(e[6]=r(" Import Warnings! "))]),d("button",{onClick:ee,class:"text-yellow-700 hover:text-yellow-900 focus:outline-none"},[t(l(Te),{class:"size-4"})])]),d("div",Ne,[d("p",$e,b(g.value),1)])])):R("",!0)]),_:1}),t(l(q),{open:j.value,"onUpdate:open":e[0]||(e[0]=a=>j.value=a)},{default:s(()=>[t(l(U),{class:"sm:max-w-[400px] flex items-center justify-center flex-col"},{default:s(()=>[t(l(z),null,{default:s(()=>[t(l(W),null,{default:s(()=>[t(l(Q),{class:"size-12 text-red-500"})]),_:1}),t(l(X))]),_:1}),d("div",Ve,[e[7]||(e[7]=d("h1",{class:"text-2xl font-bold"},"Error",-1)),d("p",Fe,b(V.value),1)])]),_:1})]),_:1},8,["open"]),t(ue,null,{default:s(()=>[t(oe,null,{default:s(()=>[t(w,{filter:"",placeholder:"Select a Branch",modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=a=>m.value=a),options:l(M),optionLabel:"label",optionValue:"value"},null,8,["modelValue","options"]),t(te,{class:"gap-5"},{default:s(()=>[t(S,null,{default:s(()=>[t(v,null,{default:s(()=>[t(u)]),_:1}),t(y,null,{default:s(()=>[d("div",Oe,[t(l(A),{onClick:Y,variant:"link",class:"text-end text-red-500 text-xs"},{default:s(()=>e[8]||(e[8]=[r(" Reset Filter ")])),_:1})]),e[9]||(e[9]=d("label",{class:"text-xs"},"From",-1)),t(l(B),{type:"date",modelValue:l(c),"onUpdate:modelValue":e[2]||(e[2]=a=>H(c)?c.value=a:c=a)},null,8,["modelValue"]),e[10]||(e[10]=d("label",{class:"text-xs"},"To",-1)),t(l(B),{type:"date",modelValue:l(p),"onUpdate:modelValue":e[3]||(e[3]=a=>H(p)?p.value=a:p=a)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(ne,null,{default:s(()=>[t(se,null,{default:s(()=>[t(h,null,{default:s(()=>e[11]||(e[11]=[r("Branch Code")])),_:1}),t(h,null,{default:s(()=>e[12]||(e[12]=[r("Branch Name")])),_:1}),t(h,null,{default:s(()=>e[13]||(e[13]=[r("POS Sales Date")])),_:1}),t(h,null,{default:s(()=>e[14]||(e[14]=[r("Transactions Count")])),_:1}),t(h,null,{default:s(()=>e[15]||(e[15]=[r("Overall Net Total")])),_:1}),t(h,null,{default:s(()=>e[16]||(e[16]=[r("Actions")])),_:1})]),_:1}),t(ae,null,{default:s(()=>[($(!0),O(we,null,ge(L.transactions.data,a=>($(),O("tr",{key:a.order_date},[t(I,null,{default:s(()=>[r(b(a.branch_code),1)]),_:2},1024),t(I,null,{default:s(()=>[r(b(a.branch_name),1)]),_:2},1024),t(I,null,{default:s(()=>[r(b(Z(a.order_date)),1)]),_:2},1024),t(I,null,{default:s(()=>[r(b(a.transaction_count),1)]),_:2},1024),t(I,null,{default:s(()=>[r(b(a.net_total),1)]),_:2},1024),t(I,{class:"flex items-center"},{default:s(()=>[t(le,{isLink:!0,href:o.route("store-transactions.index",{order_date:new Date(a.order_date).toLocaleDateString("en-CA",{year:"numeric",month:"2-digit",day:"2-digit"}),branchId:a.store_branch_id})},null,8,["href"])]),_:2},1024)]))),128))]),_:1})]),_:1}),t(re,{data:L.transactions},null,8,["data"])]),_:1}),t(l(q),{open:x.value,"onUpdate:open":e[5]||(e[5]=a=>x.value=a)},{default:s(()=>[t(l(U),{class:"sm:max-w-[600px]"},{default:s(()=>[t(l(z),null,{default:s(()=>[t(l(W),null,{default:s(()=>e[17]||(e[17]=[r("Import Store Transactions List")])),_:1}),t(l(X),null,{default:s(()=>e[18]||(e[18]=[r(" Import the excel file here. ")])),_:1})]),_:1}),t(P,null,{default:s(()=>[t(ie,null,{default:s(()=>e[19]||(e[19]=[r(" Store Transactions List ")])),_:1}),t(l(B),{disabled:_.value,type:"file",onInput:e[4]||(e[4]=a=>l(C).store_transactions_file=a.target.files[0])},null,8,["disabled"]),t(de,null,{default:s(()=>[r(b(l(C).errors.store_transactions_file),1)]),_:1})]),_:1}),t(P,null,{default:s(()=>[t(l(ye),{class:"text-xs"},{default:s(()=>e[20]||(e[20]=[r("Store Transaction Template")])),_:1}),e[21]||(e[21]=d("ul",null,[d("li",{class:"text-xs"},[r(" Template: "),d("a",{class:"text-blue-500 underline",href:"/excel/store-transactions-template"},"Click to download")])],-1))]),_:1}),t(l(Se),null,{default:s(()=>[t(l(A),{disabled:_.value||!l(C).store_transactions_file,onClick:K,class:"gap-2"},{default:s(()=>[e[22]||(e[22]=r(" Proceed ")),_.value?($(),O("span",Le,[t(ce)])):R("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["open"])]),_:1},8,["exportRoute"])}}};export{He as default};
