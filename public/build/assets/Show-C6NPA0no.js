import{Y as qe,f as Ae,x as L,T as Le,y as Ne,l as O,r as y,o as n,c as k,w as l,a,g as c,b as i,t as u,n as Y,u as f,h as x,d as v,e as j,m as J,A as E,X as ee,ay as te,F as W,k as se,N as R}from"./app-p8ycGfai.js";import{u as Te}from"./useBackButton-DYna6UI2.js";import{u as Fe}from"./useToast-BAk2IYqi.js";import{u as Se}from"./useAuth-CsB0rIGq.js";import{S as ae}from"./save-CTh84Lhv.js";import{S as le}from"./square-pen-CI0P5sG9.js";import{P as Me}from"./paperclip--9WRFhz4.js";import{L as Ee}from"./loader-circle-PEkmcZqs.js";import{C as Be}from"./circle-alert-DTQS8jZO.js";const $e={class:"flex flex-col gap-5"},Ue={class:"sm:flex-row flex flex-col gap-5"},Pe={class:"text-gray-700 text-sm"},Ve={class:"font-bold"},Re={class:"text-gray-700 text-sm"},ze={class:"font-bold"},Ge={class:"sm:flex-row flex flex-col gap-5"},Oe={class:"text-gray-700 text-sm"},je={class:"text-gray-700 text-sm"},We={class:"font-bold"},He={class:"sm:flex-row flex flex-col gap-5"},Qe={class:"text-gray-700 text-sm"},Ke={class:"font-bold"},Xe={key:0},Ze={key:1,class:"flex items-center gap-4"},Ye={key:0},Je={key:0},et={key:1,class:"flex items-center gap-2"},tt={key:0,class:"flex justify-end mt-2"},st={key:0,class:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"},at={class:"px-4 sm:px-6 py-4 bg-gradient-to-r from-blue-50 to-blue-100 border-b border-blue-200"},lt={class:"flex items-center gap-3"},ot={class:"p-4 sm:p-6"},rt={class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"},nt=["onClick","onKeydown","aria-label"],it={class:"aspect-w-1 aspect-h-1"},ut={key:0,class:"absolute inset-0 bg-gray-100 rounded-lg flex items-center justify-center"},dt={key:1,class:"absolute inset-0 bg-red-50 rounded-lg flex flex-col items-center justify-center p-4"},ct={class:"text-xs text-red-700 text-center mb-2"},pt={key:0,class:"text-xs text-gray-600 mb-2"},vt={class:"flex gap-2"},ft=["onClick"],gt={key:0,class:"text-xs text-gray-500"},yt=["src","alt","onLoad","onError","onLoadstart"],_t={key:0,class:"absolute bottom-1 left-1 bg-black bg-opacity-75 text-white text-xs p-1 rounded max-w-full truncate pointer-events-none"},mt={key:0,class:"block text-yellow-300"},bt={key:1,class:"absolute top-1 left-1 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"},xt={__name:"Show",props:{wastage:{type:Object,required:!0},permissions:{type:Object,required:!0}},setup(g){const z=Ae(),{toast:N}=Fe(),{hasAccess:S}=Se(),{backButton:oe}=Te(route("wastage-approval-lvl2.index")),T=g,re=t=>t?new Date(t).toLocaleDateString("en-PH",{year:"numeric",month:"short",day:"numeric"}):"N/A",ne=t=>{var e,o,r;return t.store_branch_name||((e=t.storeBranch)==null?void 0:e.name)||((o=t.storeBranch)==null?void 0:o.branch_name)||((r=t.storeBranch)==null?void 0:r.brand_name)||"Unknown Store"},ie=t=>{switch(t.toUpperCase()){case"APPROVED_LVL2":return"bg-green-500 text-white";case"APPROVED_LVL1":return"bg-blue-500 text-white";case"PENDING":return"bg-yellow-500 text-white";case"CANCELLED":return"bg-red-500 text-white";default:return"bg-gray-500 text-white"}},M=L(!1),w=L(null),q=L("");L(null);const H={mounted:t=>{const e=t.tagName==="INPUT"?t:t.querySelector("input");e&&(e.focus(),e.select())}},$=Le({order_id:null,remarks:null}),ue=t=>{z.require({message:"Are you sure you want to approve this wastage record?",header:"Confirmation",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Cancel",severity:"secondary",outlined:!0},acceptProps:{label:"Confirm",severity:"info"},accept:()=>{M.value=!0,$.order_id=t,$.post(route("wastage-approval-lvl2.approve"),{onSuccess:()=>{N.add({severity:"success",summary:"Success",detail:"Wastage record approved successfully.",life:3e3}),R.get(route("wastage-approval-lvl2.index"),{},{replace:!0})},onError:()=>{M.value=!1}})}})},de=t=>{z.require({message:"Are you sure you want to cancel this wastage record?",header:"Confirmation",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Cancel",severity:"secondary",outlined:!0},acceptProps:{label:"Confirm",severity:"danger"},accept:()=>{M.value=!0,$.order_id=t,$.post(route("wastage-approval-lvl2.cancel"),{onSuccess:()=>{N.add({severity:"success",summary:"Success",detail:"Wastage record cancelled successfully.",life:3e3}),R.get(route("wastage-approval-lvl2.index"),{},{replace:!0})},onError:()=>{M.value=!1}})}})},F=L([]);Ne(()=>T.wastage,t=>{t&&t.items&&(w.value||(F.value=t.items.map(e=>{var o,r,d;return{id:e.id,wastage_qty:e.wastage_qty,approverlvl1_qty:e.approverlvl1_qty??e.wastage_qty,approverlvl2_qty:e.approverlvl2_qty??e.approverlvl1_qty??e.wastage_qty,item_code:(o=e.sap_masterfile)==null?void 0:o.ItemCode,description:(r=e.sap_masterfile)==null?void 0:r.ItemDescription,cost:e.cost,uom:(d=e.sap_masterfile)==null?void 0:d.BaseUOM}})))},{immediate:!0,deep:!0});const Q=t=>{const e=F.value.find(o=>o.id===t);e&&(w.value={id:t,originalValue:e.approverlvl2_qty},q.value=e.approverlvl2_qty.toString())},U=()=>{if(!w.value)return;const t=parseFloat(q.value);if(isNaN(t)||t<0){N.add({severity:"error",summary:"Error",detail:"Please enter a valid quantity.",life:3e3});return}const e=Number(t.toFixed(2)),o=w.value.id,r=w.value.originalValue,d=F.value.find(b=>b.id===o);d&&(d.approverlvl2_qty=e),ce(o,e,r),w.value=null,q.value=""},P=()=>{w.value=null,q.value=""},ce=(t,e,o)=>{R.post(route("wastage-approval-lvl2.update-quantity",t),{approverlvl2_qty:e},{preserveScroll:!0,onSuccess:r=>{if(r.props.wastage&&r.props.wastage.items){const d=r.props.wastage.items.find(b=>b.id===t);if(d){const b=F.value.find(_=>_.id===t);b&&(b.approverlvl2_qty=d.approverlvl2_qty)}}N.add({severity:"success",summary:"Success",detail:"Quantity updated successfully.",life:2e3})},onError:r=>{const d=F.value.find(_=>_.id===t);d&&(d.approverlvl2_qty=o);const b=r.approverlvl2_qty||r.message||"Failed to update quantity. Please refresh the page.";N.add({severity:"error",summary:"Error",detail:b,life:3e3})}})},K=t=>{z.require({message:"Are you sure you want to delete this item?",header:"Confirmation",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Cancel",severity:"secondary",outlined:!0},acceptProps:{label:"Delete",severity:"danger"},accept:()=>{R.delete(route("wastage-approval-lvl2.destroy-item",t),{preserveScroll:!0,onSuccess:()=>{N.add({severity:"success",summary:"Success",detail:"Item deleted successfully.",life:3e3})},onError:e=>{const o=Object.values(e).join(" ");N.add({severity:"error",summary:"Error",detail:o||"Failed to delete item.",life:3e3})}})}})},C=L({}),h=L({}),I=L({}),pe=(t,e=0)=>{if(!t)return{url:"",isGoogleDrive:!1,hasMoreFallbacks:!1};if(t.includes("drive.google.com"))try{let o=null;if(t.includes("/file/d/")){const r=t.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);r&&(o=r[1])}else if(t.includes("open?id=")){const r=t.match(/[?&]id=([a-zA-Z0-9_-]+)/);r&&(o=r[1])}if(o){const r=[`/proxy/google-drive/${o}`,`https://drive.google.com/thumbnail?id=${o}&sz=s400`,`https://drive.google.com/uc?export=view&id=${o}`,`https://drive.google.com/uc?export=download&id=${o}`,`https://docs.google.com/uc?export=view&id=${o}`,`https://lh3.googleusercontent.com/d/${o}=s400`];return e<r.length?{url:r[e],isGoogleDrive:!0,hasMoreFallbacks:e<r.length-1,fileId:o,attemptIndex:e,totalFormats:r.length,allFormats:r}:{url:"",isGoogleDrive:!0,hasMoreFallbacks:!1,fileId:o}}}catch(o){console.error("Error transforming Google Drive URL:",o,"URL:",t)}return{url:t,isGoogleDrive:!1,hasMoreFallbacks:!1}},X=O(()=>{var o,r;let t=[];return(o=T.wastage)!=null&&o.image_urls&&Array.isArray(T.wastage.image_urls)&&T.wastage.image_urls.length>0?t=T.wastage.image_urls:(r=T.wastage)!=null&&r.image_url&&(t=[T.wastage.image_url]),t.map(d=>{I.value[d]===void 0&&(I.value[d]=0);const b=I.value[d],_=pe(d,b);return{type:"existing",url:_.url,id:d,originalUrl:d,urlInfo:_,attemptIndex:b}})}),ve=O(()=>X.value.length>0),fe=O(()=>{try{return!1}catch(t){return console.warn("Could not determine development mode:",t),!1}}),ge=t=>{C.value[t]=!1,h.value[t]=null,I.value[t]=0},ye=(t,e)=>{if(e.urlInfo&&e.urlInfo.isGoogleDrive&&e.urlInfo.hasMoreFallbacks){const o=(I.value[t]||0)+1;I.value[t]=o;return}C.value[t]=!1,e.urlInfo&&e.urlInfo.isGoogleDrive?h.value[t]=`Failed to load image after trying ${e.urlInfo.totalFormats} different URL formats. The Google Drive file may not be publicly accessible or may have been deleted.`:h.value[t]="Failed to load image. The URL may be invalid or the image may not be accessible."},_e=t=>{const e=t.id;C.value[e]=!0,h.value[e]=null},me=t=>{t.urlInfo&&t.urlInfo.isGoogleDrive&&t.urlInfo.hasMoreFallbacks?(I.value[t.id]=(I.value[t.id]||0)+1,h.value[t.id]=null,C.value[t.id]=!0):(I.value[t.id]=0,h.value[t.id]=null,C.value[t.id]=!0)},G=(t,e)=>{C.value[t.id]||h.value[t.id]||window.open(t.url,"_blank")};return(t,e)=>{const o=y("Badge"),r=y("Button"),d=y("DivFlexCenter"),b=y("TableHeader"),_=y("TH"),be=y("TableHead"),A=y("TD"),Z=y("Input"),xe=y("TableBody"),we=y("Table"),he=y("MobileTableHeading"),B=y("LabelXS"),ke=y("MobileTableRow"),Ce=y("MobileTableContainer"),Ie=y("TableContainer"),De=y("Layout");return n(),k(De,{heading:"Wastage Record Details"},{default:l(()=>[a(Ie,null,{default:l(()=>[c("section",$e,[c("section",Ue,[c("span",Pe,[e[4]||(e[4]=i(" Wastage Number: ")),c("span",Ve,u(g.wastage.wastage_no),1)]),c("span",Re,[e[5]||(e[5]=i(" Store: ")),c("span",ze,u(ne(g.wastage)),1)])]),c("section",Ge,[c("span",Oe,[e[6]||(e[6]=i(" Status: ")),a(o,{class:Y([ie(g.wastage.wastage_status),"font-bold"])},{default:l(()=>{var s;return[i(u(((s=g.wastage.wastage_status)==null?void 0:s.toUpperCase().replace("_"," "))??"N/A"),1)]}),_:1},8,["class"])]),c("span",je,[e[7]||(e[7]=i(" Date: ")),c("span",We,u(re(g.wastage.created_at)),1)])]),c("section",He,[c("span",Qe,[e[8]||(e[8]=i(" Remarks: ")),c("span",Ke,u(g.wastage.remarks??"No remarks provided"),1)])]),a(d,{class:"gap-5"},{default:l(()=>[g.wastage.wastage_status==="approved_lvl1"&&f(S)("cancel wastage approval level 2")?(n(),k(r,{key:0,variant:"destructive",onClick:e[0]||(e[0]=s=>de(g.wastage.id)),disabled:M.value},{default:l(()=>e[9]||(e[9]=[i(" Cancel Wastage ")])),_:1},8,["disabled"])):x("",!0),g.wastage.wastage_status==="approved_lvl1"&&f(S)("approve wastage level 2")?(n(),k(r,{key:1,class:"bg-green-500 hover:bg-green-300",onClick:e[1]||(e[1]=s=>ue(g.wastage.id)),disabled:M.value},{default:l(()=>e[10]||(e[10]=[i(" Approve Wastage ")])),_:1},8,["disabled"])):x("",!0)]),_:1})]),a(b),a(we,null,{default:l(()=>[a(be,null,{default:l(()=>[a(_,null,{default:l(()=>e[11]||(e[11]=[i(" Item Code ")])),_:1}),a(_,null,{default:l(()=>e[12]||(e[12]=[i(" Description ")])),_:1}),a(_,null,{default:l(()=>e[13]||(e[13]=[i(" Reason ")])),_:1}),a(_,null,{default:l(()=>e[14]||(e[14]=[i(" UOM ")])),_:1}),a(_,null,{default:l(()=>e[15]||(e[15]=[i(" Wastage Qty ")])),_:1}),a(_,null,{default:l(()=>e[16]||(e[16]=[i(" Approved Lvl1 Qty ")])),_:1}),g.wastage.wastage_status==="approved_lvl1"?(n(),k(_,{key:0},{default:l(()=>e[17]||(e[17]=[i("Approved Lvl2 Qty")])),_:1})):(n(),k(_,{key:1},{default:l(()=>e[18]||(e[18]=[i("Approved Lvl2 Qty")])),_:1}))]),_:1}),a(xe,null,{default:l(()=>[(n(!0),v(W,null,j(g.wastage.items,s=>(n(),v("tr",{key:s.id},[a(A,null,{default:l(()=>{var p;return[i(u(((p=s.sap_masterfile)==null?void 0:p.ItemCode)||"N/A"),1)]}),_:2},1024),a(A,null,{default:l(()=>{var p;return[i(u(((p=s.sap_masterfile)==null?void 0:p.ItemDescription)||"N/A"),1)]}),_:2},1024),a(A,{class:"text-sm"},{default:l(()=>[i(u(s.reason||"No reason specified"),1)]),_:2},1024),a(A,null,{default:l(()=>{var p,m;return[i(u((((p=s.sap_masterfile)==null?void 0:p.AltUOM)||((m=s.sap_masterfile)==null?void 0:m.BaseUOM))??"N/A"),1)]}),_:2},1024),a(A,null,{default:l(()=>[i(u(s.wastage_qty),1)]),_:2},1024),a(A,null,{default:l(()=>[i(u(s.approverlvl1_qty),1)]),_:2},1024),g.wastage.wastage_status==="approved_lvl1"?(n(),k(A,{key:0,class:"flex items-center gap-3"},{default:l(()=>{var p;return[w.value&&w.value.id===s.id?(n(),v("div",Xe,[J(a(Z,{type:"number",modelValue:q.value,"onUpdate:modelValue":e[2]||(e[2]=m=>q.value=m),class:"w-20 text-right",onKeyup:[E(U,["enter"]),E(P,["esc"])]},null,8,["modelValue"]),[[H]]),a(d,{class:"gap-1 ml-2"},{default:l(()=>[a(f(ae),{class:"size-4 text-green-500 cursor-pointer hover:text-green-600",onClick:U}),a(f(ee),{class:"size-4 text-red-500 cursor-pointer hover:text-red-600",onClick:P})]),_:1})])):(n(),v("div",Ze,[i(u(((p=F.value.find(m=>m.id===s.id))==null?void 0:p.approverlvl2_qty)??0)+" ",1),f(S)("edit wastage approval level 2")?(n(),k(f(le),{key:0,class:"size-4 text-blue-500 cursor-pointer hover:text-blue-600",onClick:m=>Q(s.id)},null,8,["onClick"])):x("",!0),f(S)("delete wastage approval level 2")?(n(),k(f(te),{key:1,class:"size-4 text-red-500 cursor-pointer hover:text-red-600",onClick:m=>K(s.id)},null,8,["onClick"])):x("",!0)]))]}),_:2},1024)):(n(),k(A,{key:1},{default:l(()=>[i(u(s.approverlvl2_qty),1)]),_:2},1024))]))),128))]),_:1})]),_:1}),a(Ce,null,{default:l(()=>[(n(!0),v(W,null,j(g.wastage.items,s=>(n(),k(ke,{key:s.id},{default:l(()=>{var p,m;return[a(he,{title:`${((p=s.sap_masterfile)==null?void 0:p.ItemDescription)||"N/A"} (${((m=s.sap_masterfile)==null?void 0:m.ItemCode)||"N/A"})`},{default:l(()=>[g.wastage.wastage_status==="approved_lvl1"&&f(S)("edit wastage approval level 2")?(n(),v("div",Ye,[w.value&&w.value.id===s.id?(n(),v("div",Je,[J(a(Z,{type:"number",modelValue:q.value,"onUpdate:modelValue":e[3]||(e[3]=D=>q.value=D),class:"w-20 text-right",onKeyup:[E(U,["enter"]),E(P,["esc"])]},null,8,["modelValue"]),[[H]]),a(d,{class:"gap-1 ml-2"},{default:l(()=>[a(f(ae),{class:"size-4 text-green-500 cursor-pointer hover:text-green-600",onClick:U}),a(f(ee),{class:"size-4 text-red-500 cursor-pointer hover:text-red-600",onClick:P})]),_:1})])):(n(),v("div",et,[a(f(le),{class:"size-4 text-blue-500 cursor-pointer hover:text-blue-600",onClick:D=>Q(s.id)},null,8,["onClick"])]))])):x("",!0)]),_:2},1032,["title"]),a(B,null,{default:l(()=>[i("Reason: "+u(s.reason||"No reason specified"),1)]),_:2},1024),a(B,null,{default:l(()=>{var D,V;return[i("UOM: "+u((((D=s.sap_masterfile)==null?void 0:D.AltUOM)||((V=s.sap_masterfile)==null?void 0:V.BaseUOM))??"N/A"),1)]}),_:2},1024),a(B,null,{default:l(()=>[i("Wastage: "+u(s.wastage_qty),1)]),_:2},1024),a(B,null,{default:l(()=>[i("Lvl1 Approved: "+u(s.approverlvl1_qty),1)]),_:2},1024),a(B,null,{default:l(()=>{var D;return[i(" Lvl2 Approved: "+u(((D=F.value.find(V=>V.id===s.id))==null?void 0:D.approverlvl2_qty)??0),1)]}),_:2},1024),g.wastage.wastage_status==="approved_lvl1"?(n(),v("div",tt,[f(S)("delete wastage approval level 2")?(n(),k(f(te),{key:0,class:"size-4 text-red-500 cursor-pointer hover:text-red-600",onClick:D=>K(s.id)},null,8,["onClick"])):x("",!0)])):x("",!0)]}),_:2},1024))),128))]),_:1})]),_:1}),ve.value?(n(),v("div",st,[c("div",at,[c("div",lt,[a(f(Me),{class:"w-5 h-5 text-blue-600"}),e[19]||(e[19]=c("h3",{class:"text-lg font-semibold text-gray-900"},"Attached Images",-1))])]),c("div",ot,[c("div",rt,[(n(!0),v(W,null,j(X.value,(s,p)=>(n(),v("div",{key:s.id,class:Y(["relative group cursor-pointer",{"cursor-zoom-in":!C.value[s.id]&&!h.value[s.id]}]),onClick:m=>G(s,p),onKeydown:[E(m=>G(s,p),["enter"]),E(se(m=>G(s,p),["prevent"]),["space"])],tabindex:"0",role:"button","aria-label":`View image ${p+1} in new tab`},[c("div",it,[C.value[s.id]?(n(),v("div",ut,[a(f(Ee),{class:"w-8 h-8 text-blue-600 animate-spin"})])):h.value[s.id]?(n(),v("div",dt,[a(f(Be),{class:"w-8 h-8 text-red-500 mb-2"}),c("p",ct,u(h.value[s.id]),1),s.urlInfo&&s.urlInfo.isGoogleDrive?(n(),v("p",pt," Tried "+u(s.urlInfo.totalFormats)+" URL formats ",1)):x("",!0),c("div",vt,[c("button",{onClick:se(m=>me(s),["stop"]),class:"text-xs text-blue-600 hover:text-blue-800 underline"},u(s.urlInfo&&s.urlInfo.isGoogleDrive&&s.urlInfo.hasMoreFallbacks?"Try Next URL":"Retry"),9,ft),s.urlInfo&&s.urlInfo.isGoogleDrive&&s.urlInfo.hasMoreFallbacks?(n(),v("span",gt," ("+u(s.urlInfo.totalFormats-(s.attemptIndex+1))+" left) ",1)):x("",!0)])])):(n(),v("img",{key:2,src:s.url,alt:`Wastage Image ${p+1}`,class:"object-cover shadow-lg rounded-lg w-full h-full hover:opacity-90 transition-opacity",onLoad:()=>ge(s.id),onError:()=>ye(s.id,s),onLoadstart:()=>_e(s)},null,40,yt))]),fe.value?(n(),v("div",_t,[i(u(s.type==="existing"?"Existing":"New")+" ",1),s.type==="existing"?(n(),v("span",mt,"ID: "+u(s.id.substring(0,10))+"...",1)):x("",!0)])):x("",!0),!C.value[s.id]&&!h.value[s.id]?(n(),v("div",bt," Click to view ")):x("",!0)],42,nt))),128))])])])):x("",!0),a(r,{variant:"outline",class:"text-lg px-7",onClick:f(oe)},{default:l(()=>e[20]||(e[20]=[i(" Back ")])),_:1},8,["onClick"])]),_:1})}}},Nt=qe(xt,[["__scopeId","data-v-04ecf1ec"]]);export{Nt as default};
